<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G02åº”ç”¨é¢˜ç›ˆäºé—®é¢˜é˜¶æ¢¯è®­ç»ƒ</title>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script id="MathJax-script" async src=".\mathjax\mathjax\es5\tex-mml-chtml.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
        }

        .header {
            text-align: center;
            width: 100%;
            margin-bottom: 20px;
        }

        .pk-container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            justify-content: space-between;
        }

        .player-container, .computer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            width: 48%;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            position: relative;
        }

        .player-container {
            background-color: #f0f8ff; /* Light blue for player */
        }

        .computer-container {
            background-color: #fff0f0; /* Light red for computer */
        }

        .vs-indicator {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            color: #333;
            background-color: #ffcc00;
            padding: 5px 15px;
            border-radius: 20px;
        }

        .difficulty-buttons {
            margin-bottom: 20px;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        .difficulty-buttons button {
            margin: 5px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #668B8B;
        }

        .difficulty-buttons button.active {
            background-color: #45a049;
            color: white;
        }

        .question-box {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: white;
            width: 90%;
        }

        .answer-input {
            padding: 10px;
            font-size: 16px;
            width: 80%;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .timer {
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
        }

        .computer-status {
            margin: 10px 0;
            font-style: italic;
            min-height: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .result {
            min-height: 20px;
            margin: 10px 0;
        }

        .score {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
        }

        .correct {
            color: green;
        }

        .incorrect {
            color: red;
        }

        .rendered-answer {
            margin-top: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            padding: 10px;
            width: 80%;
            min-height: 30px;
            background-color: white;
        }

        .history-container {
            margin-top: 30px;
            width: 100%;
            max-width: 1200px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f4f4f4;
        }

        .copy-button {
            margin-top: 10px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
        }

        .copy-button:hover {
            background-color: #218838;
        }

        #copy-success {
            display: none;
            margin-top: 10px;
            color: green;
            font-size: 14px;
        }
        
        .winner-indicator {
            font-weight: bold;
            font-size: 18px;
            margin: 10px 0;
        }
        
        .player-win {
            color: blue;
        }
        
        .computer-win {
            color: red;
        }
        
        .tie {
            color: purple;
        }
        
        .player-row {
            background-color: rgba(240, 248, 255, 0.3);
        }
        
        .computer-row {
            background-color: rgba(255, 240, 240, 0.3);
        }
        
        /* æ–°å¢æ”»å‡»æ•ˆæœç›¸å…³æ ·å¼ */
        .shockwave {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.1);
            box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0.7);
        }
        
        .player-attack {
            animation: shockwave-player 1s ease-out forwards;
        }
        
        .computer-attack {
            animation: shockwave-computer 1s ease-out forwards;
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shockwave-player {
            0% {
                opacity: 1;
                transform: scale(0.1);
                background: radial-gradient(circle, rgba(0,100,255,0.8) 0%, rgba(0,100,255,0) 70%);
                box-shadow: 0 0 20px 10px rgba(0, 100, 255, 0.7);
                left: 35%;
                top: 50%;
            }
            100% {
                opacity: 0;
                transform: scale(2);
                background: radial-gradient(circle, rgba(0,100,255,0.2) 0%, rgba(0,100,255,0) 70%);
                box-shadow: 0 0 40px 20px rgba(0, 100, 255, 0.3);
                left: 80%;
                top: 50%;
            }
        }
        
        @keyframes shockwave-computer {
            0% {
                opacity: 1;
                transform: scale(0.1);
                background: radial-gradient(circle, rgba(255,0,0,0.8) 0%, rgba(255,0,0,0) 70%);
                box-shadow: 0 0 20px 10px rgba(255, 0, 0, 0.7);
                left: 65%;
                top: 50%;
            }
            100% {
                opacity: 0;
                transform: scale(2);
                background: radial-gradient(circle, rgba(255,0,0,0.2) 0%, rgba(255,0,0,0) 70%);
                box-shadow: 0 0 40px 20px rgba(255, 0, 0, 0.3);
                left: 20%;
                top: 50%;
            }
        }
        
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            10%, 30%, 50%, 70%, 90% {transform: translateX(-5px);}
            20%, 40%, 60%, 80% {transform: translateX(5px);}
        }
        
        /* æ˜¾ç¤ºå¯¹è¯®è¯­å¥çš„æ ·å¼ */
        .taunt-bubble {
            position: absolute;
            background-color: white;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 10px;
            font-size: 14px;
            font-weight: bold;
            z-index: 101;
            opacity: 0;
            animation: show-taunt 2s ease-out forwards;
            min-width: 120px;
            text-align: center;
        }
        
        .taunt-bubble::before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 10px solid transparent;
        }
        
        .player-taunt {
            top: 20%;
            left: 25%;
        }
        
        .player-taunt::before {
            border-left-color: #333;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .computer-taunt {
            top: 20%;
            right: 25%;
        }
        
        .computer-taunt::before {
            border-right-color: #333;
            left: -20px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        @keyframes show-taunt {
            0% {opacity: 0; transform: translateY(20px);}
            20% {opacity: 1; transform: translateY(0);}
            80% {opacity: 1; transform: translateY(0);}
            100% {opacity: 0; transform: translateY(-20px);}
        }
        
        @media (max-width: 768px) {
            .pk-container {
                flex-direction: column;
            }
            
            .player-container, .computer-container {
                width: 90%;
                margin-bottom: 30px;
            }
        }

        .timer-btn {
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #668B8B;
            color: white;
            margin: 0 5px;
        }
        
        .timer-btn.active {
            background-color: #45a049;
        }

        /* æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .mode-switch {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        
        .mode-btn {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #668B8B;
            color: white;
            margin: 0 10px;
        }
        
        .mode-btn.active {
            background-color: #45a049;
        }
        
        /* è‡ªå­¦æ¨¡å¼ä¸‹çš„å…¨å®½ç©å®¶å®¹å™¨ */
        .player-container.full-width {
            width: 100%;
        }
        
        /* å†å²è®°å½•ä¸Šæ–¹æŒ‰é’®è¡Œ */
        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        /* å“åº”å¼å¸ƒå±€ä¸‹çš„å†å²è®°å½•æŒ‰é’® */
        @media (max-width: 768px) {
            .history-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-switch {
                margin-top: 10px;
            }
        }

        /* é€šå…³æ¨¡å¼ç›¸å…³æ ·å¼ */
        .level-progress {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .level-indicator {
            font-size: 16px;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .question-counter {
            font-size: 14px;
        }
        
        .conquest-timer {
            font-size: 14px;
            margin-left: 15px;
            color: #007bff;
        }
        
        /* å·²é€šå…³çš„å…³å¡é«˜äº®æ ·å¼ */
        .difficulty-buttons button.completed {
            background-color: #28a745;
            color: white;
            position: relative;
        }
        
        .difficulty-buttons button.completed::after {
            content: "âœ“";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ffc107;
            color: #000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .difficulty-buttons button.current {
            background-color: #007bff;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }
        
        @media (max-width: 768px) {
            .pk-container {
                flex-direction: column;
            }
            
            .player-container, .computer-container {
                width: 90%;
                margin-bottom: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h3>G02åº”ç”¨é¢˜ç›ˆäºé—®é¢˜é˜¶æ¢¯è®­ç»ƒ</h3>
    </div>
    
    <!-- æ·»åŠ éŸ³æ•ˆå…ƒç´  -->
    <audio id="playerAttackSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2073/2073-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="computerAttackSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/1293/1293-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="correctSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.mp3" type="audio/mpeg">
    </audio>
    <audio id="wrongSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/2691/2691-preview.mp3" type="audio/mpeg">
    </audio>
    
    <div class="difficulty-buttons" id="difficultyButtons"></div>
    
    <!-- æ¸¸æˆé€‰é¡¹å¸ƒå±€ä¿®æ”¹ä¸ºä¸€è¡Œ -->
    <div class="game-options" style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; margin: 10px 0;">
        <div style="display: flex; align-items: center; margin: 0 10px;">

            <button id="timer5min" class="timer-btn" onclick="selectGameDuration(5)">5åˆ†é’Ÿ</button>
            <button id="timer10min" class="timer-btn active" onclick="selectGameDuration(10)">10åˆ†é’Ÿ</button>
        </div>
        
        <div style="display: flex; align-items: center; margin: 0 10px;">
            <span style="margin-right: 10px;">è®¡ç®—æœºæ€è€ƒéš¾åº¦:</span>
            <button id="thinkingEasy" class="timer-btn active" onclick="selectThinkingDifficulty('easy')">å¿«</button>
            <button id="thinkingMedium" class="timer-btn" onclick="selectThinkingDifficulty('medium')">ä¸­</button>
            <button id="thinkingHard" class="timer-btn" onclick="selectThinkingDifficulty('hard')">æ…¢</button>
        </div>
    </div>
    <div style="display: flex; justify-content: center; align-items: center; margin: 10px 0; gap: 15px;">
        <div id="countdownDisplay" style="font-size: 20px; font-weight: bold; color: #007bff;">å‰©ä½™æ—¶é—´: 05:00</div>
        <button id="startGameBtn" onclick="startGame()">å¼€å§‹æ¸¸æˆ</button>
        <button id="resetGameBtn" onclick="resetGame()" disabled>é‡æ–°å¼€å§‹</button>
    </div>
    
    <div class="pk-container">
        <div class="player-container" id="playerContainer">
            <h3>ç©å®¶</h3>
            <div class="timer" id="playerTimer">æ—¶é—´: 0ç§’</div>
            <div class="question-box" id="playerQuestion"></div>
            <input type="text" id="playerAnswer" class="answer-input" placeholder="è¾“å…¥ä½ çš„ç­”æ¡ˆ" oninput="updatePreview('player')" disabled autocomplete="off">
            <div class="rendered-answer" id="playerRenderedAnswer"></div>
            <button id="playerSubmitBtn" onclick="checkPlayerAnswer()" disabled>æäº¤ç­”æ¡ˆ</button>
            <div class="result" id="playerResult"></div>
            <div class="score" id="playerScore">æ­£ç¡®: 0 | é”™è¯¯: 0 | æ€»é¢˜æ•°: 0</div>
        </div>
        
        <div class="computer-container" id="computerContainer">
            <h3>è®¡ç®—æœº</h3>
            <div class="timer" id="computerTimer">æ—¶é—´: 0ç§’</div>
            <div class="question-box" id="computerQuestion"></div>
            <div class="computer-status" id="computerStatus">ç­‰å¾…å¼€å§‹...</div>
            <input type="text" id="computerAnswer" class="answer-input" placeholder="è®¡ç®—æœºçš„ç­”æ¡ˆ" disabled autocomplete="off">
            <div class="rendered-answer" id="computerRenderedAnswer"></div>
            <div class="result" id="computerResult"></div>
            <div class="score" id="computerScore">æ­£ç¡®: 0 | é”™è¯¯: 0 | æ€»é¢˜æ•°: 0</div>
        </div>
    </div>
    
    <div class="winner-indicator" id="roundResult"></div>
    
    <div class="history-container">
        <div class="history-controls">
            <button class="copy-button" onclick="copyHistory()">å¤åˆ¶å†å²è®°å½•</button>
            
            <!-- æ¨¡å¼åˆ‡æ¢æŒ‰é’®ç§»åˆ°è¿™é‡Œ -->
            <div class="mode-switch">
                <button id="selfPracticeBtn" class="mode-btn" onclick="switchMode('self')">è‡ªå­¦ç»ƒä¹ </button>
                <button id="pkModeBtn" class="mode-btn active" onclick="switchMode('pk')">PKæ¨¡å¼</button>
                <button id="conquestModeBtn" class="mode-btn" onclick="switchMode('conquest')">é€šå…³æ¨¡å¼</button>
            </div>
        </div>
        
        <div id="copy-success">å†å²è®°å½•å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼</div>
        
        <table>
            <thead>
                <tr>
                    <th>å‚ä¸è€…</th>
                    <th>çº§åˆ«</th>
                    <th>é¢˜ç›®</th>
                    <th>ç­”æ¡ˆ</th>
                    <th>æ­£ç¡®ç­”æ¡ˆ</th>
                    <th>ç»“æœ</th>
                    <th>ç”¨æ—¶(ç§’)</th>
                </tr>
            </thead>
            <tbody id="history"></tbody>
        </table>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let playerCorrectAnswer; // ç©å®¶é¢˜ç›®çš„æ­£ç¡®ç­”æ¡ˆ
        let computerCorrectAnswer; // è®¡ç®—æœºé¢˜ç›®çš„æ­£ç¡®ç­”æ¡ˆ
        let correctAnswer; // ä¿ç•™æ­¤å˜é‡ç”¨äºå…¼å®¹åŸæœ‰å‡½æ•°
        let playerCorrectCount = 0;
        let playerIncorrectCount = 0;
        let computerCorrectCount = 0;
        let computerIncorrectCount = 0;
        let playerTotalCount = 0;
        let computerTotalCount = 0;
        let currentDifficulty = 1;
        let gameInProgress = false;
        let playerTime = 0;
        let computerTime = 0;
        let playerQuestionStartTime = 0;
        let computerQuestionStartTime = 0;
        let playerTimer;
        let computerTimer;
        let computerThinkingTimers = [];
        
        // æ–°å¢å€’è®¡æ—¶å˜é‡
        let gameDuration = 10; // é»˜è®¤10åˆ†é’Ÿ
        let countdownTime = 10 * 60; // é»˜è®¤10åˆ†é’Ÿï¼Œå•ä½ä¸ºç§’
        let countdownTimer;
        
        // æ–°å¢æ€è€ƒæ—¶é—´éš¾åº¦å˜é‡
        let computerThinkingDifficulty = 'easy';
        
        // é€šå…³æ¨¡å¼å˜é‡
        let conquestLevel = 1; // å½“å‰å…³å¡
        let conquestCorrectCount = 0; // å½“å‰å…³å¡å·²ç­”å¯¹çš„é¢˜ç›®æ•°
        let conquestStartTime = 0; // é€šå…³æ¨¡å¼å¼€å§‹æ—¶é—´
        let conquestTotalTime = 0; // é€šå…³æ¨¡å¼æ€»ç”¨æ—¶ // é»˜è®¤ä¸ºå®¹æ˜“ï¼Œå¯é€‰å€¼: 'easy'(å®¹æ˜“)ã€'medium'(ä¸­ç­‰)ã€'hard'(å›°éš¾)
        
        // æ–°å¢æ¸¸æˆæ¨¡å¼å˜é‡
        let gameMode = 'self'; // é»˜è®¤ä¸ºselfæ¨¡å¼ï¼Œå¯é€‰å€¼: 'self'(è‡ªå­¦ç»ƒä¹ )ã€'pk'(PKæ¨¡å¼)ã€'conquest'(é€šå…³æ¨¡å¼)

        const difficultyNames = ["01åˆ†é…ä¸­çš„æ¯”è¾ƒ1", "02åˆ†é…ä¸­çš„æ¯”è¾ƒ2", "03ç›ˆç›ˆé—®é¢˜", "04ç›ˆäºé—®é¢˜", "05äºäºé—®é¢˜", "06ä¸€ä¸ªå¯¹è±¡çš„ç›ˆäºé—®é¢˜", "07ç›ˆäºé—®é¢˜ç»¼åˆæµ‹è¯•"];

        // åˆå§‹åŒ–
        document.addEventListener("DOMContentLoaded", () => {
            generateDifficultyButtons();
            setDifficulty(1);
            updateCountdownDisplay();
            switchMode('self'); // é»˜è®¤selfæ¨¡å¼
            selectThinkingDifficulty('hard'); // é»˜è®¤ä¸ºå›°éš¾éš¾åº¦
        });

        // åˆ‡æ¢æ¸¸æˆæ¨¡å¼
        function switchMode(mode) {
            if (gameInProgress) {
                alert('æ¸¸æˆè¿›è¡Œä¸­æ— æ³•åˆ‡æ¢æ¨¡å¼ï¼Œè¯·å…ˆé‡ç½®æ¸¸æˆ');
                return;
            }
            
            gameMode = mode;
            
            // æ›´æ–°UIæŒ‰é’®çŠ¶æ€
            document.getElementById('selfPracticeBtn').classList.toggle('active', mode === 'self');
            document.getElementById('pkModeBtn').classList.toggle('active', mode === 'pk');
            document.getElementById('conquestModeBtn').classList.toggle('active', mode === 'conquest');
            
            const playerContainer = document.getElementById('playerContainer');
            const computerContainer = document.getElementById('computerContainer');
            const countdownDisplay = document.getElementById('countdownDisplay');
            
            if (mode === 'self') {
                // è‡ªå­¦ç»ƒä¹ æ¨¡å¼
                computerContainer.style.display = 'none';
                playerContainer.classList.add('full-width');
                countdownDisplay.style.display = 'block';
                document.getElementById('startGameBtn').textContent = 'å¼€å§‹ç»ƒä¹ ';
                document.getElementById('roundResult').style.display = 'none';
            } else if (mode === 'pk') {
                // PKæ¨¡å¼
                computerContainer.style.display = 'flex';
                playerContainer.classList.remove('full-width');
                countdownDisplay.style.display = 'block';
                document.getElementById('startGameBtn').textContent = 'å¼€å§‹PK';
                document.getElementById('roundResult').style.display = 'block';
            } else if (mode === 'conquest') {
                // é€šå…³æ¨¡å¼
                computerContainer.style.display = 'none';
                playerContainer.classList.add('full-width');
                countdownDisplay.style.display = 'none';
                document.getElementById('startGameBtn').textContent = 'å¼€å§‹é€šå…³';
                document.getElementById('roundResult').style.display = 'block';
                
                // é‡ç½®é€šå…³æ¨¡å¼å˜é‡
                conquestLevel = 1;
                conquestCorrectCount = 0;
                conquestStartTime = 0;
                
                // è®¾ç½®å½“å‰éš¾åº¦ä¸ºç¬¬ä¸€å…³
                setDifficulty(1);
            }
            
            // æ›´æ–°é€šå…³æ¨¡å¼çš„éš¾åº¦æŒ‰é’®çŠ¶æ€ï¼ˆå¯¹æ‰€æœ‰æ¨¡å¼éƒ½è°ƒç”¨ï¼Œå‡½æ•°å†…éƒ¨ä¼šå¤„ç†ï¼‰
            updateDifficultyButtonsForConquest();
            
            // æ›´æ–°ç•Œé¢æŒ‰é’®çŠ¶æ€
            updateButtonStates();
        }

        function generateDifficultyButtons() {
            const difficultyButtonsContainer = document.getElementById('difficultyButtons');
            difficultyNames.forEach((name, index) => {
                const button = document.createElement('button');
                button.textContent = name;
                button.id = `level${index + 1}`;
                button.dataset.level = index + 1; // æ·»åŠ data-levelå±æ€§
                button.onclick = () => setDifficulty(index + 1);
                difficultyButtonsContainer.appendChild(button);
            });
        }

        function setDifficulty(level) {
            if (gameInProgress) return; // æ¸¸æˆè¿›è¡Œä¸­ä¸èƒ½æ›´æ”¹éš¾åº¦
            
            currentDifficulty = level;
            document.querySelectorAll('.difficulty-buttons button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`level${level}`).classList.add('active');
        }

        // é€‰æ‹©æ¸¸æˆæ—¶é•¿
        function selectGameDuration(minutes) {
            if (gameInProgress) return; // æ¸¸æˆè¿›è¡Œä¸­ä¸èƒ½æ›´æ”¹æ—¶é•¿
            
            gameDuration = minutes;
            countdownTime = minutes * 60;
            
            // æ›´æ–°UI - å…ˆç§»é™¤æ‰€æœ‰timer-btnçš„activeç±»
            document.querySelectorAll('.timer-btn').forEach(btn => {
                // åªå¤„ç†æ—¶é—´é€‰æ‹©æŒ‰é’®ï¼Œä¸å½±å“æ€è€ƒéš¾åº¦æŒ‰é’®
                if (btn.id.startsWith('timer')) {
                    btn.classList.remove('active');
                }
            });
            // åªç»™å½“å‰é€‰æ‹©çš„æŒ‰é’®æ·»åŠ activeç±»
            document.getElementById(`timer${minutes}min`).classList.add('active');
            
            updateCountdownDisplay();
        }
        
        // é€‰æ‹©è®¡ç®—æœºæ€è€ƒéš¾åº¦
        function selectThinkingDifficulty(difficulty) {
            if (gameInProgress) return; // æ¸¸æˆè¿›è¡Œä¸­ä¸èƒ½æ›´æ”¹éš¾åº¦
            
            computerThinkingDifficulty = difficulty;
            
            // æ›´æ–°UI - åªæ“ä½œæ€è€ƒéš¾åº¦æŒ‰é’®
            document.querySelectorAll('.timer-btn').forEach(btn => {
                // åªå¤„ç†æ€è€ƒéš¾åº¦æŒ‰é’®ï¼Œä¸å½±å“æ—¶é—´é€‰æ‹©æŒ‰é’®
                if (btn.id.startsWith('thinking')) {
                    btn.classList.remove('active');
                }
            });
            document.getElementById(`thinking${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}`).classList.add('active');
        }
        
        // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
        function updateCountdownDisplay() {
            const minutes = Math.floor(countdownTime / 60);
            const seconds = countdownTime % 60;
            document.getElementById('countdownDisplay').textContent = 
                `å‰©ä½™æ—¶é—´: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // å¼€å§‹å€’è®¡æ—¶
        function startCountdown() {
            countdownTime = gameDuration * 60;
            updateCountdownDisplay();
            
            countdownTimer = setInterval(() => {
                countdownTime--;
                updateCountdownDisplay();
                
                if (countdownTime <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function startGame() {
            // é‡ç½®çŠ¶æ€
            playerCorrectCount = 0;
            playerIncorrectCount = 0;
            computerCorrectCount = 0;
            computerIncorrectCount = 0;
            playerTotalCount = 0;
            computerTotalCount = 0;
            playerTime = 0;
            computerTime = 0;
            
            // é€šå…³æ¨¡å¼ç‰¹æ®Šåˆå§‹åŒ–
            if (gameMode === 'conquest') {
                conquestStartTime = new Date().getTime();
                conquestCorrectCount = 0;
                conquestLevel = 1;
                setDifficulty(1);
                updateDifficultyButtonsForConquest();
                
                // æ·»åŠ é€šå…³è¿›åº¦æ˜¾ç¤º
                if (!document.getElementById('levelProgress')) {
                    const progressDiv = document.createElement('div');
                    progressDiv.id = 'levelProgress';
                    progressDiv.className = 'level-progress';
                    document.getElementById('playerContainer').insertBefore(progressDiv, document.getElementById('playerContainer').firstChild.nextSibling);
                }
                updateConquestUI();
            }
            
            // æ›´æ–°UI
            document.getElementById('playerScore').innerHTML = `æ­£ç¡®: 0 | é”™è¯¯: 0 | æ€»é¢˜æ•°: 0`;
            if (gameMode === 'pk') {
                document.getElementById('computerScore').innerHTML = `æ­£ç¡®: 0 | é”™è¯¯: 0 | æ€»é¢˜æ•°: 0`;
                document.getElementById('computerTimer').innerHTML = `æ—¶é—´: 0ç§’`;
                document.getElementById('roundResult').innerHTML = '';
            } else if (gameMode === 'conquest') {
                document.getElementById('roundResult').innerHTML = 'å¼€å§‹é€šå…³æŒ‘æˆ˜ï¼';
                document.getElementById('roundResult').className = 'winner-indicator';
            }
            document.getElementById('playerTimer').innerHTML = `æ—¶é—´: 0ç§’`;
            document.getElementById('history').innerHTML = '';
            
            // å¯ç”¨/ç¦ç”¨ç›¸å…³æŒ‰é’®
            document.getElementById('startGameBtn').disabled = true;
            document.getElementById('resetGameBtn').disabled = false;
            document.getElementById('playerAnswer').disabled = false;
            document.getElementById('playerSubmitBtn').disabled = false;
            
            // æ›´æ”¹æ¸¸æˆçŠ¶æ€
            gameInProgress = true;
            
            // ä¸ºç©å®¶ç”Ÿæˆé¢˜ç›®
            generatePlayerQuestion();
            
            // å¼€å§‹è®¡æ—¶å™¨
            startTimers();
            
            // å¯åŠ¨å€’è®¡æ—¶ - ä»…åœ¨éé€šå…³æ¨¡å¼ä¸‹
            if (gameMode !== 'conquest') {
                startCountdown();
            }
            
            // ä»…åœ¨PKæ¨¡å¼ä¸‹æ‰ç”Ÿæˆè®¡ç®—æœºé¢˜ç›®
            if (gameMode === 'pk') {
                generateComputerQuestion();
            }
        }
        
        function resetGame() {
            // åœæ­¢è®¡æ—¶å™¨
            clearInterval(playerTimer);
            clearInterval(computerTimer);
            clearInterval(countdownTimer);
            computerThinkingTimers.forEach(timer => clearTimeout(timer));
            computerThinkingTimers = [];
            
            // é‡ç½®çŠ¶æ€
            gameInProgress = false;
            countdownTime = gameDuration * 60;
            updateCountdownDisplay();
            
            // é€šå…³æ¨¡å¼ç‰¹æ®Šé‡ç½®
            if (gameMode === 'conquest') {
                conquestLevel = 1;
                conquestCorrectCount = 0;
                conquestStartTime = 0;
                setDifficulty(1);
                updateDifficultyButtonsForConquest();
                
                // ç§»é™¤é€šå…³è¿›åº¦æ˜¾ç¤º
                const progressDiv = document.getElementById('levelProgress');
                if (progressDiv) {
                    progressDiv.remove();
                }
            }
            
            // æ›´æ–°UI
            document.getElementById('playerQuestion').innerHTML = '';
            document.getElementById('playerAnswer').value = '';
            document.getElementById('playerRenderedAnswer').innerHTML = '';
            document.getElementById('playerResult').innerHTML = '';
            
            if (gameMode === 'pk') {
                document.getElementById('computerQuestion').innerHTML = '';
                document.getElementById('computerAnswer').value = '';
                document.getElementById('computerRenderedAnswer').innerHTML = '';
                document.getElementById('computerResult').innerHTML = '';
                document.getElementById('computerStatus').innerHTML = 'ç­‰å¾…å¼€å§‹...';
                document.getElementById('roundResult').innerHTML = '';
            } else if (gameMode === 'conquest') {
                document.getElementById('roundResult').innerHTML = '';
            }
            
            // å¯ç”¨/ç¦ç”¨ç›¸å…³æŒ‰é’®
            updateButtonStates();
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates() {
            document.getElementById('startGameBtn').disabled = gameInProgress;
            document.getElementById('resetGameBtn').disabled = !gameInProgress;
            document.getElementById('playerAnswer').disabled = !gameInProgress;
            document.getElementById('playerSubmitBtn').disabled = !gameInProgress;
        }
        
        function startTimers() {
            // ç©å®¶è®¡æ—¶å™¨
            playerTimer = setInterval(() => {
                playerTime++;
                document.getElementById('playerTimer').innerHTML = `æ—¶é—´: ${playerTime}ç§’`;
            }, 1000);
            
            // ä»…åœ¨PKæ¨¡å¼ä¸‹å¯åŠ¨è®¡ç®—æœºè®¡æ—¶å™¨
            if (gameMode === 'pk') {
                computerTimer = setInterval(() => {
                    computerTime++;
                    document.getElementById('computerTimer').innerHTML = `æ—¶é—´: ${computerTime}ç§’`;
                }, 1000);
                
                // è®¾ç½®è®¡ç®—æœºè‡ªåŠ¨ç­”é¢˜
                //scheduleComputerAnswer();
            }
            
            // è®°å½•å¼€å§‹æ—¶é—´
            playerQuestionStartTime = playerTime;
            if (gameMode === 'pk') {
                computerQuestionStartTime = computerTime;
            }
        }
        
        function generatePlayerQuestion() {
            // æ¸…ç©ºç­”æ¡ˆæ¡†å’Œç»“æœ
            document.getElementById('playerAnswer').value = '';
            document.getElementById('playerRenderedAnswer').innerHTML = '';
            document.getElementById('playerResult').innerHTML = '';
            
            // ç”Ÿæˆæ–°é¢˜ç›®
            const playerQuestion = generateQuestion();
            // ä¿å­˜ç©å®¶é¢˜ç›®çš„æ­£ç¡®ç­”æ¡ˆ
            playerCorrectAnswer = [...correctAnswer];
            
            // æ›´æ–°ç•Œé¢ä¸Šçš„é¢˜ç›®
            document.getElementById('playerQuestion').innerHTML = playerQuestion;
            
            // è®°å½•é¢˜ç›®å¼€å§‹æ—¶é—´
            playerQuestionStartTime = playerTime;
            
            // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
            MathJax.typesetPromise([document.getElementById('playerQuestion')])
                .catch((err) => console.log(err));
        }
        
        function generateComputerQuestion() {
            if (gameMode !== 'pk') return;
            
            // æ¸…ç©ºç­”æ¡ˆæ¡†å’Œç»“æœ
            document.getElementById('computerAnswer').value = '';
            document.getElementById('computerRenderedAnswer').innerHTML = '';
            document.getElementById('computerResult').innerHTML = '';
            
            // ç”Ÿæˆæ–°é¢˜ç›®
            const computerQuestion = generateQuestion();
            // ä¿å­˜è®¡ç®—æœºé¢˜ç›®çš„æ­£ç¡®ç­”æ¡ˆ
            computerCorrectAnswer = [...correctAnswer];
            
            // æ›´æ–°ç•Œé¢ä¸Šçš„é¢˜ç›®
            document.getElementById('computerQuestion').innerHTML = computerQuestion;
            
            // æ›´æ–°è®¡ç®—æœºçŠ¶æ€
            document.getElementById('computerStatus').innerHTML = `æ­£åœ¨æ€è€ƒ...`;
            
            // è®°å½•é¢˜ç›®å¼€å§‹æ—¶é—´
            computerQuestionStartTime = computerTime;
            
            // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
            MathJax.typesetPromise([document.getElementById('computerQuestion')])
                .catch((err) => console.log(err));
            
            // è®¾ç½®è®¡ç®—æœºè‡ªåŠ¨ç­”é¢˜
            scheduleComputerAnswer();
        }
        
        function scheduleComputerAnswer() {
            if (!gameInProgress || gameMode !== 'pk') return;
            
            // æ ¹æ®éš¾åº¦è®¾ç½®è®¡ç®—æœºæ€è€ƒæ—¶é—´
            let minTime = 10;
            let maxTime = 20;
            
            switch(computerThinkingDifficulty) {
                case 'easy': // å®¹æ˜“ï¼š10-20ç§’
                    minTime = 10;
                    maxTime = 20;
                    break;
                case 'medium': // ä¸­ç­‰ï¼š20-40ç§’
                    minTime = 20;
                    maxTime = 40;
                    break;
                case 'hard': // å›°éš¾ï¼š30-45ç§’
                    minTime = 30;
                    maxTime = 45;
                    break;
            }
            
            // ç”ŸæˆæŒ‡å®šèŒƒå›´å†…çš„éšæœºæ€è€ƒæ—¶é—´
            const thinkingTime = Math.floor(Math.random() * (maxTime - minTime + 1)) + minTime;
            
            // è®¾ç½®è®¡ç®—æœºè‡ªåŠ¨ç­”é¢˜å®šæ—¶å™¨
            const timer = setTimeout(() => {
                if (gameInProgress && gameMode === 'pk') {
                    submitComputerAnswer();
                }
            }, thinkingTime * 1000);
            
            // æ·»åŠ åˆ°å®šæ—¶å™¨åˆ—è¡¨ä»¥ä¾¿é‡ç½®æ¸¸æˆæ—¶æ¸…é™¤
            computerThinkingTimers.push(timer);
        }
        
        function checkPlayerAnswer() {
            if (!gameInProgress) return;
            
            const userAnswer = document.getElementById('playerAnswer').value.trim();
            
            if (userAnswer === '') {
                document.getElementById('playerResult').innerHTML = 'è¯·è¾“å…¥ç­”æ¡ˆï¼';
                document.getElementById('playerResult').className = 'result incorrect';
                return;
            }
            
            // è®¡ç®—ç­”é¢˜ç”¨æ—¶
            const questionTime = playerTime - playerQuestionStartTime;
            
            // ä½¿ç”¨ toHalfWidth å‡½æ•°å°†ç”¨æˆ·è¾“å…¥è½¬æ¢ä¸ºåŠè§’å­—ç¬¦
            const normalizedUserAnswer = toHalfWidth(userAnswer.replace(/\s/g, '').toLowerCase());
            
            // å¯¹äºæ­£æ•°ç­”æ¡ˆï¼ŒåŒæ—¶æ¥å—å¸¦"+"å·å’Œä¸å¸¦"+"å·çš„å½¢å¼
            const normalizedCorrectAnswers = playerCorrectAnswer.map(answer => {
                const num = parseInt(answer);
                if (num > 0) {
                    return [answer, `+${answer}`]; // æ­£æ•°åŒæ—¶æ¥å—å¸¦"+"å·å’Œä¸å¸¦"+"å·çš„å½¢å¼
                }
                return [answer]; // è´Ÿæ•°åªæ¥å—ä¸€ç§å½¢å¼
            }).flat();
            
            // æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
            const isCorrect = normalizedCorrectAnswers.some(answer => 
                normalizedUserAnswer === toHalfWidth(answer.replace(/\s/g, '').toLowerCase()));
            
            if (isCorrect) {
                document.getElementById('playerResult').innerHTML = 'æ­£ç¡®!';
                document.getElementById('playerResult').className = 'result correct';
                playerCorrectCount++;
                
                // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
                document.getElementById('correctSound').play();
                
                // ä»…åœ¨PKæ¨¡å¼ä¸‹æ˜¾ç¤ºæ”»å‡»æ•ˆæœ
                if (gameMode === 'pk') {
                    // åˆ›å»ºå¹¶æ·»åŠ å†²å‡»æ³¢å…ƒç´ 
                    createShockwave('player');
                    
                    // è®©è®¡ç®—æœºå®¹å™¨æŠ–åŠ¨
                    document.getElementById('computerContainer').classList.add('shake');
                    setTimeout(() => {
                        document.getElementById('computerContainer').classList.remove('shake');
                    }, 500);
                    
                    // æ˜¾ç¤ºå¯¹è¯®è¯­å¥
                    showTaunt('player');
                }
            } else {
                document.getElementById('playerResult').innerHTML = 'é”™è¯¯';
                document.getElementById('playerResult').className = 'result incorrect';
                playerIncorrectCount++;
                
                // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
                document.getElementById('wrongSound').play();
            }
            
            // æ›´æ–°æ€»é¢˜æ•°
            playerTotalCount++;
            
            // æ›´æ–°åˆ†æ•°
            updatePlayerScore();
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            addToHistory('ç©å®¶', difficultyNames[currentDifficulty - 1], 
                          document.getElementById('playerQuestion').innerHTML, 
                          userAnswer, playerCorrectAnswer.join(' æˆ– '), 
                          isCorrect ? 'æ­£ç¡®' : 'é”™è¯¯', questionTime);
            
            // é€šå…³æ¨¡å¼ç‰¹æ®Šå¤„ç†
            if (gameMode === 'conquest' && isCorrect) {
                conquestCorrectCount++;
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆå½“å‰å…³å¡ï¼ˆæ¯å…³éœ€è¦ç­”å¯¹5é¢˜ï¼‰
                if (conquestCorrectCount >= 5) {
                    conquestLevel++;
                    conquestCorrectCount = 0;
                    
                    // æ£€æŸ¥æ˜¯å¦é€šå…³æ‰€æœ‰å…³å¡
                    if (conquestLevel > difficultyNames.length) {
                        // é€šå…³æˆåŠŸ
                        const totalTime = Math.floor((new Date().getTime() - conquestStartTime) / 1000);
                        document.getElementById('roundResult').innerHTML = `ğŸ‰ æ­å–œé€šå…³ï¼æ€»ç”¨æ—¶: ${totalTime}ç§’`;
                        document.getElementById('roundResult').className = 'winner-indicator player-win';
                        endGame();
                        return;
                    } else {
                        // è¿›å…¥ä¸‹ä¸€å…³
                        setDifficulty(conquestLevel);
                        updateDifficultyButtonsForConquest();
                        document.getElementById('roundResult').innerHTML = `ğŸŠ ç¬¬${conquestLevel-1}å…³é€šè¿‡ï¼è¿›å…¥ç¬¬${conquestLevel}å…³`;
                        document.getElementById('roundResult').className = 'winner-indicator player-win';
                    }
                }
                
                // æ›´æ–°é€šå…³è¿›åº¦æ˜¾ç¤º
                updateConquestUI();
            }
            
            // ç«‹å³ç”Ÿæˆæ–°é¢˜ç›®
            generatePlayerQuestion();
        }
        
        function submitComputerAnswer() {
            if (!gameInProgress || gameMode !== 'pk') return;
            
            // è®¡ç®—ç­”é¢˜ç”¨æ—¶
            const questionTime = computerTime - computerQuestionStartTime;
            
            // ä½¿ç”¨è®¡ç®—æœºé¢˜ç›®çš„æ­£ç¡®ç­”æ¡ˆ
            const computerAnswer = computerCorrectAnswer[0];
            
            // éšæœºå†³å®šè®¡ç®—æœºæ˜¯å¦ç­”å¯¹ï¼ˆ90%çš„æ¦‚ç‡ç­”å¯¹ï¼‰
            const isCorrect = Math.random() < 0.9;
            
            let displayAnswer;
            if (isCorrect) {
                displayAnswer = computerAnswer;
            } else {
                // å¦‚æœè¦é”™ï¼Œåˆ™æ˜¾ç¤ºä¸€ä¸ªç¨å¾®ä¸åŒçš„ç­”æ¡ˆ
                displayAnswer = parseInt(computerAnswer) + (Math.random() > 0.5 ? 1 : -1);
            }
            
            // æ›´æ–°çŠ¶æ€ä¸º"æ­£åœ¨è¾“å…¥"
            document.getElementById('computerStatus').innerHTML = 'æ­£åœ¨è¾“å…¥...';
            
            // æ¸…ç©ºè®¡ç®—æœºç­”æ¡ˆæ¡†
            document.getElementById('computerAnswer').value = '';
            document.getElementById('computerRenderedAnswer').innerHTML = '';
            
            // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºç­”æ¡ˆ
            let currentIndex = 0;
            const typingInterval = setInterval(() => {
                if (currentIndex < displayAnswer.toString().length) {
                    // æ¯æ¬¡æ·»åŠ ä¸€ä¸ªå­—ç¬¦
                    document.getElementById('computerAnswer').value += displayAnswer.toString().charAt(currentIndex);
                    document.getElementById('computerRenderedAnswer').innerHTML = '\\(' + document.getElementById('computerAnswer').value + '\\)';
                    
                    // é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
                    MathJax.typesetPromise([document.getElementById('computerRenderedAnswer')])
                        .catch((err) => console.log(err));
                        
                    currentIndex++;
                } else {
                    // æ‰“å­—å®Œæˆï¼Œæ¸…é™¤å®šæ—¶å™¨
                    clearInterval(typingInterval);
                    
                    // æ˜¾ç¤ºç»“æœ
                    if (isCorrect) {
                        document.getElementById('computerResult').innerHTML = 'æ­£ç¡®!';
                        document.getElementById('computerResult').className = 'result correct';
                        computerCorrectCount++;
                        
                        // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
                        document.getElementById('correctSound').play();
                        
                        // åˆ›å»ºå¹¶æ·»åŠ å†²å‡»æ³¢å…ƒç´ 
                        createShockwave('computer');
                        
                        // è®©ç©å®¶å®¹å™¨æŠ–åŠ¨
                        document.getElementById('playerContainer').classList.add('shake');
                        setTimeout(() => {
                            document.getElementById('playerContainer').classList.remove('shake');
                        }, 500);
                        
                        // æ˜¾ç¤ºå¯¹è¯®è¯­å¥
                        showTaunt('computer');
                    } else {
                        document.getElementById('computerResult').innerHTML = 'é”™è¯¯';
                        document.getElementById('computerResult').className = 'result incorrect';
                        computerIncorrectCount++;
                        
                        // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
                        document.getElementById('wrongSound').play();
                    }
                    
                    // æ›´æ–°çŠ¶æ€
                    document.getElementById('computerStatus').innerHTML = 'å·²ä½œç­”';
                    
                    // æ›´æ–°æ€»é¢˜æ•°
                    computerTotalCount++;
                    
                    // æ›´æ–°åˆ†æ•°
                    updateComputerScore();
                    
                    // æ·»åŠ åˆ°å†å²è®°å½•
                    addToHistory('è®¡ç®—æœº', difficultyNames[currentDifficulty - 1], 
                                document.getElementById('computerQuestion').innerHTML, 
                                displayAnswer, computerCorrectAnswer.join(' æˆ– '), 
                                isCorrect ? 'æ­£ç¡®' : 'é”™è¯¯', questionTime);
                    
                    // çŸ­æš‚å»¶è¿Ÿåç”Ÿæˆæ–°é¢˜ç›®
                    setTimeout(() => {
                        if (gameInProgress && gameMode === 'pk') {
                            generateComputerQuestion();
                        }
                    }, 8000);
                }
            }, 500); // æ¯500æ¯«ç§’æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œç›¸å½“äºæ¯ç§’æ˜¾ç¤º2ä¸ªå­—ç¬¦
        }
        
        function updatePlayerScore() {
            document.getElementById('playerScore').innerHTML = `æ­£ç¡®: ${playerCorrectCount} | é”™è¯¯: ${playerIncorrectCount} | æ€»é¢˜æ•°: ${playerTotalCount}| å¾—åˆ†: ${playerCorrectCount - playerIncorrectCount} `;
        }
        
        function updateComputerScore() {
            document.getElementById('computerScore').innerHTML = `æ­£ç¡®: ${computerCorrectCount} | é”™è¯¯: ${computerIncorrectCount} | æ€»é¢˜æ•°: ${computerTotalCount}| å¾—åˆ†: ${computerCorrectCount - computerIncorrectCount} `;
        }
        
        function addToHistory(participant, level, question, answer, correctAnswer, result, time) {
            const historyTable = document.getElementById('history');
            const newRow = historyTable.insertRow(0);
            
            // è®¾ç½®è¡Œçš„ç±»
            if (participant === 'ç©å®¶') {
                newRow.classList.add("player-row");
            } else {
                newRow.classList.add("computer-row");
            }
            
            // æ·»åŠ ç»“æœç±»
            if (result === 'æ­£ç¡®') {
                newRow.classList.add(participant === 'ç©å®¶' ? "player-win" : "computer-win");
            }
            
            // å¡«å……å•å…ƒæ ¼å†…å®¹
            newRow.insertCell(0).innerHTML = participant;
            newRow.insertCell(1).innerHTML = level;
            newRow.insertCell(2).innerHTML = question;
            newRow.insertCell(3).innerHTML = '\\(' + answer + '\\)';
            newRow.insertCell(4).innerHTML = '\\(' + correctAnswer + '\\)';
            newRow.insertCell(5).innerHTML = result;
            newRow.insertCell(6).innerHTML = time + 'ç§’';
            
            // é‡æ–°æ¸²æŸ“æ–°æ·»åŠ çš„è¡Œä¸­çš„æ•°å­¦å…¬å¼
            MathJax.typesetPromise([newRow]).catch((err) => console.log(err));
        }
        
        function updatePreview(player) {
            const input = document.getElementById('playerAnswer').value;
            const renderedAnswer = document.getElementById('playerRenderedAnswer');
            renderedAnswer.style.display = 'block';
            renderedAnswer.innerHTML = '\\(' + input + '\\)';
            MathJax.typesetPromise([renderedAnswer]).catch((err) => console.log(err));
        }
        
        function toHalfWidth(str) {
            return str.replace(/[\uFF01-\uFF5E]/g, function(char) {
                return String.fromCharCode(char.charCodeAt(0) - 0xFEE0);
            }).replace(/\u3000/g, ' ');
        }
        
        function copyHistory() {
            // åˆ›å»ºå†å²è®°å½•çš„JSONå¯¹è±¡
            const historyData = {
                records: [],
                result: {}
            };
            
            // è·å–è¡¨æ ¼å†…å®¹
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if(cells.length >= 7) {
                    const record = {
                        participant: cells[0].innerText,
                        level: cells[1].innerText,
                        question: cells[2].innerText.replace(/\\\(|\\\)/g, ''), // ç§»é™¤\( \)æ ‡è®°
                        answer: cells[3].innerText.replace(/\\\(|\\\)/g, ''),
                        correctAnswer: cells[4].innerText.replace(/\\\(|\\\)/g, ''),
                        result: cells[5].innerText,
                        time: parseInt(cells[6].innerText)
                    };
                    historyData.records.push(record);
                }
            });
            
            // æ·»åŠ æœ€ç»ˆç»“æœ
            historyData.result = {
                playerCorrect: playerCorrectCount,
                playerIncorrect: playerIncorrectCount,
                playerTotal: playerTotalCount,
                playerScore: playerCorrectCount - playerIncorrectCount,
                computerCorrect: computerCorrectCount,
                computerIncorrect: computerIncorrectCount,
                computerTotal: computerTotalCount,
                computerScore: computerCorrectCount - computerIncorrectCount,
                gameMode: gameMode,
                gameDuration: gameDuration,
                difficulty: difficultyNames[currentDifficulty - 1]
            };

            // è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
            const jsonStr = JSON.stringify(historyData, null, 2);

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(jsonStr).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçš„æç¤º
                const copySuccess = document.getElementById('copy-success');
                copySuccess.style.display = 'block';
                setTimeout(() => {
                    copySuccess.style.display = 'none';
                }, 2000); // 2ç§’åéšè—æç¤º
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥: ', err);
            });
        }
        
        document.getElementById('playerAnswer').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                checkPlayerAnswer();
            }
        });

        // æ¸¸æˆç»“æŸå‡½æ•°
        function endGame() {
            // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
            clearInterval(playerTimer);
            clearInterval(computerTimer);
            clearInterval(countdownTimer);
            computerThinkingTimers.forEach(timer => clearTimeout(timer));
            computerThinkingTimers = [];
            
            // æ›´æ”¹æ¸¸æˆçŠ¶æ€
            gameInProgress = false;
            
            // ç¦ç”¨ç©å®¶è¾“å…¥
            document.getElementById('playerAnswer').disabled = true;
            document.getElementById('playerSubmitBtn').disabled = true;
            
            // ä»…åœ¨PKæ¨¡å¼ä¸‹æ˜¾ç¤ºæ¸¸æˆç»“æœ
            if (gameMode === 'pk') {
                let resultMessage = '';
                let playerNetScore = playerCorrectCount - playerIncorrectCount;
                let computerNetScore = computerCorrectCount - computerIncorrectCount;
                
                if (playerNetScore > computerNetScore) {
                    resultMessage = `æ¸¸æˆç»“æŸ! ç©å®¶è·èƒœ! (${playerNetScore} : ${computerNetScore})`;
                    document.getElementById('roundResult').className = 'winner-indicator player-win';
                } else if (playerNetScore < computerNetScore) {
                    resultMessage = `æ¸¸æˆç»“æŸ! è®¡ç®—æœºè·èƒœ! (${playerNetScore} : ${computerNetScore})`;
                    document.getElementById('roundResult').className = 'winner-indicator computer-win';
                } else {
                    resultMessage = `æ¸¸æˆç»“æŸ! å¹³å±€! (${playerNetScore} : ${computerNetScore})`;
                    document.getElementById('roundResult').className = 'winner-indicator tie';
                }
                document.getElementById('roundResult').innerHTML = resultMessage;
            } else {
                // è‡ªå­¦ç»ƒä¹ æ¨¡å¼
                document.getElementById('roundResult').innerHTML = `ç»ƒä¹ ç»“æŸ! å…±å®Œæˆ${playerTotalCount}é¢˜ï¼Œæ­£ç¡®${playerCorrectCount}é¢˜ï¼Œå¾—åˆ†: ${playerCorrectCount - playerIncorrectCount}`;
                document.getElementById('roundResult').style.display = 'block';
                document.getElementById('roundResult').className = 'winner-indicator';
            }
            
            // å¯ç”¨é‡ç½®æŒ‰é’®
            document.getElementById('resetGameBtn').disabled = false;
        }



        // ä»¥ä¸‹æ˜¯ç”Ÿæˆé¢˜ç›®çš„å‡½æ•°ï¼Œä¸åŸæœ‰ä»£ç ç›¸åŒ

        function generateQuestion() {
            switch(currentDifficulty) {
                case 1: return generateLevel1Question();
                case 2: return generateLevel2Question();
                case 3: return generateLevel3Question();
                case 4: return generateLevel4Question();
                case 5: return generateLevel5Question();
                case 6: return generateLevel6Question();
                case 7: return generateLevel7Question();
                default: return "";
            }
        }

 
        function generateLevel1Question() {
   let a = Math.floor(Math.random() * 8)+1 ;
   let b = Math.floor(Math.random() * 8)+1 ;

   let d = (Math.random() > 0.5 ? "å·§å…‹åŠ›" : "ææ‹‰ç±³è‹");

  
    let textq =  `\\begin{array}{cc} 
                 è€å¸ˆç»™åŒå­¦ä»¬åˆ†${d}, \\\\ 
                å¦‚æœæ¯ä¸ªåŒå­¦å¤šå‘${a}å—${d};\\\\
                é‚£ä¹ˆè€å¸ˆå‰©ä¸‹çš„${d}å°±å°‘äº†${a*b}å—;\\\\
                é‚£ä¹ˆæœ‰å¤šå°‘ååŒå­¦ï¼Ÿ\\\\
               \\end{array}`;
    correctAnswer = [`${b}`]  
    return `\\( ${textq}  \\)`;

}
     





function generateLevel2Question() {
    let a = Math.floor(Math.random() * 8)+1 ;
    let b = Math.floor(Math.random() * 8)+1 ;
    let c = Math.floor(Math.random() * 8)+1 ;
   let d = (Math.random() > 0.5 ? "å·§å…‹åŠ›" : "ææ‹‰ç±³è‹");


    let m = a*b+c;

    
    let textq =  `\\begin{array}{cc} 
                è€å¸ˆç»™åŒå­¦ä»¬åˆ†${d},æ¯ä¸ªåŒå­¦åˆ†å¾—ä¸€æ ·å¤š;  \\\\ 
                 è¿˜å‰©ä¸‹${m}å—ï¼›åæ¥åˆæ¥äº†${a}ä½åŒå­¦; \\\\ 
                åˆ†ç»™ä»–ä»¬åŒæ ·çš„${d}å,åªå‰©ä¸‹${c}å—${d};\\\\
                é‚£ä¹ˆæ¯ä½åŒå­¦åˆ†åˆ°å¤šå°‘å—${d}ï¼Ÿ\\\\
               \\end{array}`;
    correctAnswer = [`${b}`]  
    return `\\( ${textq}  \\)`;
}

















function generateLevel3Question() {
    let a = Math.floor(Math.random() * 30)+10 ;//äººç‰©æ•°é‡
    let b = Math.floor(Math.random() * 8)+3 ;//ç¬¬ä¸€æ¬¡åˆ†å‘
    let c = Math.floor(Math.random() * 8)+3 ;//ç¬¬äºŒæ¬¡åˆ†å‘
    let d = Math.floor(Math.random() * 20)+5 ;//æœ€åä½™ä¸‹
    let x = (Math.random() > 0.5 ? "å·§å…‹åŠ›" : "ææ‹‰ç±³è‹");

    
    let textq =  `\\begin{array}{cc} 
                è€å¸ˆç»™åŒå­¦ä»¬åˆ†${x},æ¯ä¸ªåŒå­¦åˆ†å¾—ä¸€æ ·å¤š;  \\\\ 
                å¦‚æœæ¯ä½åŒå­¦åˆ†${b}å—ï¼›åˆ™å‰©ä¸‹${a*c+d}å—; \\\\ 
                å¦‚æœæ¯ä½åŒå­¦åˆ†${b+c}å—ï¼›åˆ™å‰©ä¸‹${d}å—; \\\\
                é‚£ä¹ˆæœ‰å¤šå°‘ä½åŒå­¦å‘¢ï¼Ÿ\\\\
               \\end{array}`;
    correctAnswer = [`${a}`]  
    return `\\( ${textq}  \\)`;
}








function generateLevel4Question() {
    let a = Math.floor(Math.random() * 30)+10 ;//äººç‰©æ•°é‡
    let b = Math.floor(Math.random() * 8)+3 ;//ç¬¬ä¸€æ¬¡åˆ†å‘
    let c = Math.floor(Math.random() * 8)+3 ;//ç¬¬äºŒæ¬¡åˆ†å‘
    let d = Math.floor(Math.random() * 10)+5 ;//æœ€åç¼ºçš„
    let x = (Math.random() > 0.5 ? "å·§å…‹åŠ›" : "ææ‹‰ç±³è‹");




    
    let textq =  `\\begin{array}{cc} 
                è€å¸ˆç»™åŒå­¦ä»¬åˆ†${x},æ¯ä¸ªåŒå­¦åˆ†å¾—ä¸€æ ·å¤š;  \\\\ 
                å¦‚æœæ¯ä½åŒå­¦åˆ†${b}å—ï¼›åˆ™å‰©ä¸‹${a*c-d}å—; \\\\ 
                å¦‚æœæ¯ä½åŒå­¦åˆ†${b+c}å—ï¼›åˆ™ç¼ºäº†${d}å—; \\\\
                é‚£ä¹ˆæœ‰å¤šå°‘ä½åŒå­¦å‘¢ï¼Ÿ\\\\
               \\end{array}`;
    correctAnswer = [`${a}`]  
    return `\\( ${textq}  \\)`;

}


function generateLevel5Question() {
    let a = Math.floor(Math.random() * 30)+10 ;//äººç‰©æ•°é‡
    let b = Math.floor(Math.random() * 8)+3 ;//ç¬¬ä¸€æ¬¡åˆ†å‘
    let c = Math.floor(Math.random() * 8)+3 ;//ç¬¬äºŒæ¬¡åˆ†å‘
    let d = Math.floor(Math.random() * 10)+5 ;///æœ€åç¼ºçš„
    let t = a*b-d;//æ€»é‡
    let x = (Math.random() > 0.5 ? "æ¡ƒå­" : "èŠ’æœ");

    
    let textq =  `\\begin{array}{cc} 
                æ‚Ÿç©ºç»™çŒ´å­ä»¬åˆ†${x},æ¯åªçŒ´å­åˆ†å¾—ä¸€æ ·å¤š;  \\\\ 
                å¦‚æœæ¯åªçŒ´å­åˆ†${b}ä¸ªï¼›åˆ™ç¼ºäº†${d}ä¸ª; \\\\ 
                å¦‚æœæ¯åªçŒ´å­åˆ†${b+c}ä¸ªï¼›åˆ™ç¼ºäº†${a*c+d}ä¸ª; \\\\
                é‚£ä¹ˆæ‚Ÿç©ºå‡†å¤‡äº†å¤šå°‘ä¸ª${x}ï¼Ÿ\\\\
               \\end{array}`;


    // éšæœºé€‰æ‹©å›¾ç‰‡
    let imageFile = Math.random() < 0.5 ? 'c0101.gif' : 'c0102.gif';

    // æ’å…¥å›¾ç‰‡
    textq += `<br/><img src="./images/${imageFile}" style="width:30%;"> <br/>   
\\[  
      \\begin{array}{c}
       å½“ä½ èƒ½ç”¨å…­ç§æ–¹æ³•åšå‡ºæ¥,\\\\
       æ‚Ÿç©ºçš„å…­æ ¹èšé½ï¼Œ\\\\
       \\huge å¤§åœ£ä¹Ÿè®¸å°±ä¼šå›å½’......
      \\end{array}       
 \\]  `       

    correctAnswer = [`${t}`]  

    return textq;
}






function generateLevel6Question() {
    let a = Math.floor(Math.random() * 30)+10 ;//äººç‰©æ•°é‡
    let b = Math.floor(Math.random() * 8)+3 ;//ç¬¬ä¸€æ¬¡åˆ†å‘
    let c = Math.floor(Math.random() * 8)+3 ;//ç¬¬äºŒæ¬¡åˆ†å‘
    let d = Math.floor(Math.random() * 10)+5 ;///æœ€åç¼ºçš„
    let e = Math.floor(Math.random() * 10)+10 ;///æœ€åç¼ºçš„

    let t = a*b+d+e;//æ€»é‡
    let x = (Math.random() > 0.5 ? "æ¡ƒå­" : "èŠ’æœ");

    
    let textq =  `\\begin{array}{cc} 
                æ‚Ÿç©ºç»™çŒ´å­ä»¬åˆ†${x},ç¬¬ä¸€åªçŒ´å­æ‹¿äº†${e}ä¸ª;  \\\\ 
                å‰©ä¸‹çš„åˆ†ç»™å…¶å®ƒçš„çŒ´å­; \\\\ 
                å¦‚æœæ¯åªçŒ´å­åˆ†${b}ä¸ªï¼›åˆ™è¿˜å‰©ä¸‹äº†${d}ä¸ª; \\\\ 
                å¦‚æœæ¯åªçŒ´å­åˆ†${b+c}ä¸ªï¼›åˆ™ç¼ºäº†${a*c-d}ä¸ª; \\\\
                é‚£ä¹ˆæ‚Ÿç©ºå‡†å¤‡äº†å¤šå°‘ä¸ª${x}ï¼Ÿ\\\\
               \\end{array}`;


    // éšæœºé€‰æ‹©å›¾ç‰‡
    let imageFile = Math.random() < 0.5 ? 'c0101.gif' : 'c0102.gif';

    // æ’å…¥å›¾ç‰‡
    textq += `<br/><img src="./images/${imageFile}" style="width:30%;"> <br/>   
\\[  
      \\begin{array}{c}
       å½“ä½ èƒ½ç”¨å…­ç§æ–¹æ³•åšå‡ºæ¥,\\\\
       æ‚Ÿç©ºçš„å…­æ ¹èšé½ï¼Œ\\\\
       \\huge å¤§åœ£ä¹Ÿè®¸å°±ä¼šå›å½’......
      \\end{array}       
 \\]  `       

    correctAnswer = [`${t}`]  

    return textq;
}




        
        function generateLevel7Question() {
            const levelFunctions = [
                generateLevel1Question,
                generateLevel2Question,
                generateLevel3Question,
                generateLevel4Question,
                generateLevel5Question,
                generateLevel6Question,

            ];

            const randomIndex = Math.floor(Math.random() * levelFunctions.length);
            const selectedFunction = levelFunctions[randomIndex];

            return selectedFunction();
        }


        // åˆ›å»ºå†²å‡»æ³¢æ•ˆæœ
        function createShockwave(attacker) {
            const shockwave = document.createElement('div');
            shockwave.className = `shockwave ${attacker}-attack`;
            
            document.body.appendChild(shockwave);
            
            // æ’­æ”¾æ”»å‡»éŸ³æ•ˆ
            document.getElementById(`${attacker}AttackSound`).play();
            
            // æ”»å‡»åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                document.body.removeChild(shockwave);
            }, 1000);
        }
        
        // ç©å®¶å’Œè®¡ç®—æœºçš„å¯¹è¯®è¯­å¥
        const playerTaunts = [
            "ç®—å¾—å¤ªæ…¢äº†ï¼",
            "è¿™é¢˜å¤ªç®€å•äº†ï¼",
            "æ¥æ‹›å§ï¼",
            "çœ‹æˆ‘çš„å‰å®³ï¼",
            "æ•°å­¦å¾ˆç®€å•å§ï¼"
        ];
        
        const computerTaunts = [
            "äººç±»çš„è®¡ç®—é€Ÿåº¦çœŸæ…¢ï¼",
            "å†å¿«ä¸€ç‚¹è¯•è¯•ï¼Ÿ",
            "è¿™å°±æ˜¯æˆ‘çš„å®åŠ›ï¼",
            "ä½ è·Ÿä¸ä¸Šæˆ‘çš„é€Ÿåº¦ï¼",
            "æœºå™¨æ™ºèƒ½èƒœè¿‡äººç±»ï¼"
        ];
        
        // æ˜¾ç¤ºå¯¹è¯®è¯­å¥
        function showTaunt(source) {
            // åˆ›å»ºå¯¹è¯®æ°”æ³¡
            const taunt = document.createElement('div');
            taunt.className = `taunt-bubble ${source}-taunt`;
            
            // éšæœºé€‰æ‹©ä¸€æ¡å¯¹è¯®è¯­å¥
            const taunts = source === 'player' ? playerTaunts : computerTaunts;
            const randomIndex = Math.floor(Math.random() * taunts.length);
            taunt.textContent = taunts[randomIndex];
            
            document.body.appendChild(taunt);
            
            // å¯¹è¯®åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
            setTimeout(() => {
                document.body.removeChild(taunt);
            }, 2000);
        }
        // æ›´æ–°é€šå…³æ¨¡å¼UI
        function updateConquestUI() {
            if (!document.getElementById('levelProgress')) return;
            
            document.getElementById('levelProgress').innerHTML = `
                <div class="level-indicator">å½“å‰å…³å¡: ${conquestLevel}</div>
                <div class="question-counter">å®Œæˆé¢˜æ•°: ${conquestCorrectCount}/5</div>
                <div class="conquest-timer">æ€»ç”¨æ—¶: ${Math.floor((new Date().getTime() - conquestStartTime) / 1000)}ç§’</div>
            `;
        }
        
        // æ›´æ–°é€šå…³æ¨¡å¼çš„éš¾åº¦æŒ‰é’®çŠ¶æ€
        function updateDifficultyButtonsForConquest() {
            if (gameMode !== 'conquest') {
                // éé€šå…³æ¨¡å¼ä¸‹ï¼Œæ¢å¤æ‰€æœ‰æŒ‰é’®çš„æ­£å¸¸çŠ¶æ€
                document.querySelectorAll('.difficulty-buttons button').forEach(btn => {
                    btn.classList.remove('completed', 'current');
                    btn.disabled = false;
                });
                return;
            }
            
            // å…ˆç§»é™¤æ‰€æœ‰éš¾åº¦æŒ‰é’®çš„activeç±»å’Œcompletedç±»
            document.querySelectorAll('.difficulty-buttons button').forEach(btn => {
                btn.classList.remove('active', 'completed', 'current');
                
                // åœ¨é€šå…³æ¨¡å¼ä¸­ï¼Œæ‰€æœ‰æŒ‰é’®éƒ½åº”è¯¥è¢«ç¦ç”¨ï¼Œé™¤äº†å½“å‰å…³å¡
                const level = parseInt(btn.dataset.level);
                if (level === conquestLevel) {
                    btn.disabled = false;
                } else {
                    btn.disabled = true;
                }
            });
            
            // æ ‡è®°å·²å®Œæˆçš„å…³å¡
            for (let i = 1; i < conquestLevel; i++) {
                const completedBtn = document.querySelector(`.difficulty-buttons button[data-level="${i}"]`);
                if (completedBtn) {
                    completedBtn.classList.add('completed');
                }
            }
            
            // æ‰¾åˆ°å½“å‰éš¾åº¦æŒ‰é’®å¹¶è®¾ä¸ºæ´»è·ƒ
            const currentBtn = document.querySelector(`.difficulty-buttons button[data-level="${conquestLevel}"]`);
            if (currentBtn) {
                currentBtn.classList.add('current');
                currentBtn.classList.add('active');
            }
        }
        
        // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º - æ”¯æŒé€šå…³æ¨¡å¼
        function updateTimers() {
            if (gameMode === 'conquest') {
                const currentTime = Math.floor((new Date().getTime() - conquestStartTime) / 1000);
                if (document.querySelector('.conquest-timer')) {
                    document.querySelector('.conquest-timer').textContent = `æ€»ç”¨æ—¶: ${currentTime}ç§’`;
                }
            }
        }
    </script>
</body>
</html>

