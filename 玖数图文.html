<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>玖数图文</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #e0f7fa; }
    .chat-container { width: 100%; max-width: 900px; margin: auto; }
    .chat-box { border: 1px solid #ddd; padding: 10px; background-color: #fff; border-radius: 10px; }
    .message { margin: 10px 0; color: black; padding: 10px; border-radius: 10px; }
    .assistant { background-color: #ffffe0; } /* 浅黄色 */
    .user { background-color: #d0f0c0; } /* 浅绿色 */
    .input-area { display: flex; align-items: center; margin-top: 10px; }
    .text-input { flex: 1; min-height: 50px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f5f5f5; overflow-y: auto; }
    #sendBtn { padding: 10px 20px; margin-left: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #sendBtn:disabled { background-color: #ccc; }
    #clearBtn { padding: 10px 20px; margin-top: 10px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; width: 100%; cursor: pointer; }
  </style>

  <!-- MathJax for rendering LaTeX -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-mml-chtml.js"></script>

  <!-- Highlight.js for syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
</head>
<body>
  <h2 style="text-align: center;">玖数图文</h2>
  <div class="chat-container">
    <div class="chat-box" id="chatBox">
      <div class="message assistant">您好！请在下方输入文字或粘贴图片进行对话。</div>
    </div>
    <div class="input-area">
      <div class="text-input" id="textInput" contenteditable="true" placeholder="输入文字或粘贴图片..."></div>
      <button id="sendBtn" onclick="sendMessage()" disabled>发送</button>
    </div>
    <button id="clearBtn" onclick="clearChat()">清除对话</button>
  </div>

  <script>
    const chatBox = document.getElementById('chatBox');
    const textInput = document.getElementById('textInput');
    let imageBase64 = '';

    // 动态检测是否可以发送消息
    function updateSendButton() {
      const textContent = textInput.innerText.trim();
      document.getElementById('sendBtn').disabled = textContent === '' && !imageBase64;
    }

    textInput.addEventListener('input', updateSendButton);

    // 处理粘贴事件以捕获图片
    textInput.addEventListener('paste', (event) => {
      const items = event.clipboardData.items;
      for (let item of items) {
        if (item.type.indexOf("image") !== -1) {
          const blob = item.getAsFile();
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '200px';
            textInput.appendChild(img);
            imageBase64 = e.target.result.split(',')[1];  // 去掉base64前缀
            updateSendButton();  // 启用发送按钮
          };
          reader.readAsDataURL(blob);
          event.preventDefault();
        }
      }
    });

    // 处理键盘事件
    textInput.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey && !event.ctrlKey) {
        event.preventDefault(); // 阻止默认的换行操作
        sendMessage();
      }
    });

    async function sendMessage() {
   const userMessage = document.createElement('div');
   userMessage.className = 'message user';
   userMessage.innerHTML = '我：' + textInput.innerHTML;
   chatBox.appendChild(userMessage);

      const assistantMessage = document.createElement('div');
      assistantMessage.className = 'message assistant';
      assistantMessage.textContent = "思考中，请稍等...";
      chatBox.appendChild(assistantMessage);

      // 获取输入内容
      let textContent = textInput.innerText.trim();
      textInput.innerHTML = '';
      updateSendButton();

      // 如果没有文本输入，且有图片，则自动添加提示文字
      if (!textContent && imageBase64) {
        textContent = "识别图片，并解读内容。并解答。";
      }

      // 构建消息内容
      const messages = [];
      if (textContent) {
        messages.push({ type: "text", text: textContent });
      }
      if (imageBase64) {
        messages.push({ type: "image_url", image_url: { url: imageBase64 } });
      }

      // 确保至少有一条消息内容
      if (messages.length === 0) {
        assistantMessage.textContent = '请输入文字或粘贴图片后再发送。';
        return;
      }

      try {
        const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer 046acb99c5a6dd6680049c766c8b454b.Jc1U4euX045uExXU'  // 替换为您的API Key
          },
          body: JSON.stringify({
            model: "glm-4v-plus",
            messages: [
              {
                role: "user",
                content: messages
              }
            ]
          })
        });

        const result = await response.json();
  if (result.choices && result.choices[0] && result.choices[0].message) {
       const content = result.choices[0].message.content;
       assistantMessage.innerHTML = '玖数：';
       typeWriter(assistantMessage, parseContent(content));
     } else {
       assistantMessage.textContent = '玖数：未能生成有效的回复内容。';
     }

      } catch (error) {
        console.error("请求出错：", error);
        assistantMessage.textContent = '出错了，请稍后再试。';
      }

      imageBase64 = ''; // 清空图片数据
    }

    function parseContent(content) {
      // 将数学公式和代码块转换为HTML
      let parsedContent = content
        .replace(/\$(.*?)\$/g, (match, p1) => `<span class="math">\\(${p1}\\)</span>`)
        .replace(/```([\s\S]*?)```/g, (match, p1) => `<pre><code>${p1}</code></pre>`);
      return parsedContent;
    }

    function typeWriter(element, htmlContent) {
      let i = 0;
      let speed = 10; // 调整打字速度

      function type() {
        if (i < htmlContent.length) {
          let currentChar = htmlContent.charAt(i);
          if (currentChar === '<') {
            // 处理HTML标签
            let tag = '';
            while (currentChar !== '>' && i < htmlContent.length) {
              tag += currentChar;
              i++;
              currentChar = htmlContent.charAt(i);
            }
            tag += '>'; // 添加闭合符号
            element.innerHTML += tag;
            i++;
          } else {
            element.innerHTML += currentChar;
            i++;
          }
          setTimeout(type, speed);
        } else {
          // 打字完成，渲染MathJax公式和代码高亮
          MathJax.typesetPromise().then(() => {
            document.querySelectorAll('pre code').forEach((block) => {
              hljs.highlightElement(block);
            });
          });
        }
      }

      type();
    }

    function clearChat() {
      chatBox.innerHTML = '<div class="message assistant">您好！请在下方输入文字或粘贴图片进行对话。</div>';
    }
  </script>
</body>
</html>
