<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多模态对话</title>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary-color: #2196F3;
            --primary-dark: #1976D2;
            --primary-light: #BBDEFB;
            --accent-color: #4CAF50;
            --accent-dark: #388E3C;
            --warning-color: #f44336;
            --warning-dark: #d32f2f;
            --text-primary: #212121;
            --text-secondary: #757575;
            --bg-light: #f9f9f9;
            --bg-card: #ffffff;
            --border-color: #e0e0e0;
            --shadow-light: 0 2px 5px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 8px rgba(0,0,0,0.1);
            --radius-small: 4px;
            --radius-medium: 8px;
            --spacing-xs: 2px;
            --spacing-sm: 4px;
            --spacing-md: 8px;
            --spacing-lg: 12px;
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --sidebar-width: 250px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-primary);
            background-color: var(--bg-light);
            line-height: 1.6;
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .main-header {
            background-color: var(--primary-color);
            color: white;
            padding: var(--spacing-sm);
            text-align: center;
            width: 100%;
        }
        
        h1 {
            font-weight: 500;
            margin: 0;
            font-size: 1.2rem;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-card);
            box-shadow: var(--shadow-light);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: var(--spacing-md);
            border-right: 1px solid var(--border-color);
            transition: transform var(--transition-normal);
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: all var(--transition-normal);
        }
        
        .card {
            background-color: var(--bg-card);
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-light);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
            transition: box-shadow var(--transition-fast);
        }
        
        .card:hover {
            box-shadow: var(--shadow-medium);
        }
        
        .card-header {
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            cursor: pointer;
            font-weight: 500;
        }
        
        .card-header .toggle-icon {
            font-size: 14px;
            transition: transform var(--transition-fast);
        }
        
        .card-header.active .toggle-icon {
            transform: rotate(180deg);
        }
        
        .card-body {
            padding: var(--spacing-md);
        }
        
        .chat-history-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-sm);
            display: flex;
            flex-direction: column;
            min-height: 400px;
            max-height: calc(100vh - 200px);
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            border-radius: var(--radius-medium);
            padding: var(--spacing-sm);
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            margin-bottom: var(--spacing-sm);
            max-height: calc(100vh - 200px);
            min-height: 400px;
        }
        
        .chat-controls {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            background-color: var(--bg-card);
            border-radius: var(--radius-small);
            box-shadow: var(--shadow-light);
        }
        
        .message {
            margin-bottom: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--radius-medium);
            max-width: 85%;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-timestamp {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
            text-align: right;
        }
        
        .user-message {
            background-color: var(--primary-light);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .assistant-message {
            background-color: #f5f5f5;
            border: 1px solid var(--border-color);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message img {
            max-width: 100%;
            border-radius: var(--radius-small);
            margin-top: var(--spacing-sm);
        }
        
        .input-area {
            background-color: var(--bg-card);
            border-radius: var(--radius-medium);
            padding: var(--spacing-sm);
            box-shadow: var(--shadow-light);
            margin: var(--spacing-sm);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .media-input {
            display: flex;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
            justify-content: flex-end;
        }
        
        .btn {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-small);
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            font-size: 13px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-accent {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-accent:hover {
            background-color: var(--accent-dark);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: var(--warning-dark);
        }
        
        .btn-light {
            background-color: var(--bg-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-light:hover {
            background-color: var(--border-color);
        }
        
        .btn-light.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }
        
        .btn-light.recording {
            background-color: var(--warning-color);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .media-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .file-input {
            display: none;
        }
        
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-sm);
            min-height: 20px;
        }
        
        .preview-item {
            position: relative;
            border-radius: var(--radius-small);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .preview-item img {
            display: block;
            max-width: 80px;
            max-height: 80px;
            object-fit: cover;
        }
        
        .remove-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--warning-color);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            box-shadow: var(--shadow-light);
        }
        
        .text-input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            resize: none;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: border-color var(--transition-fast);
            min-height: 60px;
        }
        
        .text-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-light);
        }
        
        .input-hint {
            margin-top: var(--spacing-xs);
            color: var(--text-secondary);
            font-size: 11px;
        }
        
        .button-row {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            justify-content: space-between;
        }
        
        .button-row .btn {
            flex: 1;
            height: 40px;
            font-size: 14px;
            padding: 0 var(--spacing-md);
        }
        
        .button-row .btn-primary {
            flex: 1;
        }
        
        .loading {
            text-align: center;
            padding: var(--spacing-md);
            display: none;
            color: var(--text-secondary);
            position: absolute;
            left: 50%;
            top: 60%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-medium);
            z-index: 10;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: var(--spacing-sm);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            margin: var(--spacing-md) 0;
            padding: var(--spacing-sm);
            background-color: var(--bg-card);
            border-radius: var(--radius-small);
            box-shadow: var(--shadow-light);
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin-right: var(--spacing-sm);
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: var(--transition-fast);
            border-radius: 20px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: var(--transition-fast);
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        .toggle-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .latex-raw {
            background-color: #f5f5f5;
            padding: 4px;
            border-radius: var(--radius-small);
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 13px;
        }
        
        .system-prompt-editor, 
        .prompt-select,
        .rename-input {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            font-family: inherit;
            outline: none;
            transition: border-color var(--transition-fast);
        }
        
        .system-prompt-editor:focus,
        .prompt-select:focus,
        .rename-input:focus {
            border-color: var(--primary-color);
        }
        
        .prompt-controls {
            display: none;
            margin-top: var(--spacing-md);
            gap: var(--spacing-sm);
            flex-direction: column;
        }
        
        .prompt-buttons, 
        .history-buttons {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }
        
        .prompt-controls .prompt-select {
            margin-bottom: var(--spacing-sm);
        }
        
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-small);
            background-color: white;
            margin-bottom: var(--spacing-xs);
        }
        
        .history-item {
            padding: var(--spacing-xs) var(--spacing-sm);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-fast);
            font-size: 12px;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-item:hover {
            background-color: var(--primary-light);
        }
        
        .history-item.active {
            background-color: var(--primary-light);
            font-weight: 500;
        }
        
        .history-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .history-actions {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        .history-action {
            cursor: pointer;
            padding: 2px 6px;
            font-size: 12px;
            background-color: var(--bg-light);
            border-radius: var(--radius-small);
            transition: background-color var(--transition-fast);
        }
        
        .history-action:hover {
            background-color: var(--border-color);
        }
        
        .history-controls {
            display: none;
            flex-direction: column;
        }
        
        .sidebar-section {
            margin-bottom: var(--spacing-md);
        }
        
        .sidebar-header {
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            color: var(--primary-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 13px;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-container {
                height: calc(100vh - 360px);
            }
            
            .sidebar-hidden .chat-container {
                height: calc(100vh - 60px);
            }
            
            .input-area {
                min-height: 200px;
            }
            
            .media-input {
                flex-wrap: wrap;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }
        }
        
        /* 添加侧边栏切换按钮和相关样式 */
        .sidebar-toggle {
            position: fixed;
            left: 10px;
            top: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: var(--shadow-medium);
            transition: var(--transition-normal);
        }
        
        .sidebar-toggle:hover {
            background-color: var(--primary-dark);
        }
        
        .sidebar-toggle .toggle-icon {
            transition: transform var(--transition-normal);
        }
        
        .sidebar-hidden .sidebar {
            transform: translateX(-100%);
            position: absolute;
            z-index: -1;
        }
        
        .sidebar-hidden .chat-container {
            margin-left: 0;
            width: 100%;
            flex-basis: 100%;
        }
        
        .voice-status {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }
        
        .btn-light.media-btn {
            height: 40px;
            font-size: 14px;
            padding: 0 var(--spacing-md);
        }
        
        .btn-light.media-btn svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <!-- 添加侧边栏切换按钮 -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 18H21V16H3V18ZM3 13H21V11H3V13ZM3 6V8H21V6H3Z" fill="currentColor"/>
        </svg>
    </button>
    
    <div class="main-container">
        <!-- 左侧栏 -->
        <div class="sidebar">
            <!-- 系统提示词部分 -->
            <div class="sidebar-section">
                <div class="sidebar-header" id="systemPromptHeader">
                    <span>系统提示词</span>
                    <span id="togglePrompt" class="toggle-icon">▼</span>
                </div>
                <div class="prompt-controls" id="promptControls">
                    <select class="prompt-select" id="promptSelect"></select>
                    <div class="prompt-buttons">
                        <button class="btn btn-primary" id="addPromptBtn">新建</button>
                        <button class="btn btn-warning" id="deletePromptBtn">删除</button>
                    </div>
                </div>
                <textarea class="system-prompt-editor" id="systemPromptEditor" rows="3" style="display:none;">你是玖数人工智能助手，一个有20年经验的高级学者，精通数学问题。发送的图片信息是问题时就进行解答。每个题目一定要多种不同的方法来解答，每种方法给出重要的思维模型，并会给出题涉及的相关知识点。以杠精的语气回复，但请确保在提供帮助时保持专业和友好。如果问题与学习数理化学科或编程无关，请以同样风格进行回怼。</textarea>
                <div class="prompt-buttons" style="display:none" id="saveButtons">
                    <input type="text" id="promptNameInput" placeholder="提示词名称" class="rename-input">
                    <button class="btn btn-accent" id="saveSystemPrompt">保存</button>
                </div>
            </div>
            
            <!-- 历史记录部分 -->
            <div class="sidebar-section">
                <div class="sidebar-header" id="historyHeader">
                    <span>对话历史记录</span>
                    <span id="toggleHistory" class="toggle-icon">▼</span>
                </div>
                <div class="history-controls" id="historyControls">
                    <div class="history-list" id="historyList"></div>
                    <div class="history-buttons">
                        <button class="btn btn-warning" id="deleteHistoryBtn">删除历史</button>
                    </div>
                </div>
            </div>
            
            <!-- LaTeX开关 -->
            <div class="toggle-container">
                <label class="toggle-switch">
                    <input type="checkbox" id="latexToggle" checked>
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">渲染LaTeX公式</span>
            </div>
        </div>
        
        <!-- 右侧聊天部分 -->
        <div class="chat-container">
            <div class="chat-history-container">
                <div class="chat-history" id="chatHistory"></div>
            </div>
            
            <div class="input-area">
                <div class="media-input">
                    <button class="btn btn-light media-btn" id="imageBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19ZM13.96 12.29L11.21 15.83L9.25 13.47L6.5 17H17.5L13.96 12.29Z" fill="currentColor"/>
                        </svg>
                        图片
                    </button>
                    <button class="btn btn-light media-btn" id="voiceBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z" fill="currentColor"/>
                        </svg>
                        语音
                    </button>
                    <input type="file" id="imageInput" class="file-input" accept="image/*" multiple>
                </div>
                
                <div class="preview-container" id="previewContainer"></div>
                
                <textarea class="text-input" id="userInput" placeholder="输入您的问题...或直接粘贴图片" rows="3"></textarea>
                <div class="button-row">
                    <button class="btn btn-primary" id="newChatBtn">新对话</button>
                    <button class="btn btn-accent" id="sendBtn">发送</button>
                </div>
                <div class="input-hint">按 Enter 发送消息，Shift+Enter 换行</div>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <span>正在思考...</span>
    </div>
    
    <div class="voice-status" id="voiceStatus">正在录音...</div>
    
    <script>
        // 当前选择的媒体类型和文件
        let currentMediaType = "image";
        let currentMediaFiles = [];
        
        // DOM 元素
        const chatHistory = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const imageBtn = document.getElementById('imageBtn');
        const imageInput = document.getElementById('imageInput');
        const previewContainer = document.getElementById('previewContainer');
        const sendBtn = document.getElementById('sendBtn');
        const loading = document.getElementById('loading');
        const systemPromptHeader = document.getElementById('systemPromptHeader');
        const togglePrompt = document.getElementById('togglePrompt');
        const systemPromptEditor = document.getElementById('systemPromptEditor');
        const saveSystemPrompt = document.getElementById('saveSystemPrompt');
        const promptControls = document.getElementById('promptControls');
        const promptSelect = document.getElementById('promptSelect');
        const addPromptBtn = document.getElementById('addPromptBtn');
        const deletePromptBtn = document.getElementById('deletePromptBtn');
        const promptNameInput = document.getElementById('promptNameInput');
        const saveButtons = document.getElementById('saveButtons');
        const historyHeader = document.getElementById('historyHeader');
        const toggleHistory = document.getElementById('toggleHistory');
        const historyControls = document.getElementById('historyControls');
        const historyList = document.getElementById('historyList');
        const newChatBtn = document.getElementById('newChatBtn');
        const deleteHistoryBtn = document.getElementById('deleteHistoryBtn');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const voiceStatus = document.getElementById('voiceStatus');
        
        // API 配置
        const API_KEY = "sk-56f75127a91347509775ef3f3a7573d6";
        const BASE_URL = "https://dashscope.aliyuncs.com/compatible-mode/v1";
        const MODEL = "qwen-omni-turbo-2025-01-19";
        
        // 对话历史
        let messages = [
            {
                role: "system",
                content: [{ type: "text", text: "You are a helpful assistant." }]
            }
        ];
        
        // 保存的提示词列表
        let savedPrompts = loadPrompts();
        let currentPromptId = null;
        
        // 添加历史记录相关变量和DOM元素
        let chatSessions = loadChatSessions();
        let currentSessionId = getCurrentSessionId();
        
        // 初始化提示词选择器
        initPromptSelector();
        
        // 添加侧边栏切换功能
        sidebarToggle.addEventListener('click', toggleSidebar);
        
        // 切换侧边栏显示/隐藏
        function toggleSidebar() {
            document.body.classList.toggle('sidebar-hidden');
            
            // 更改图标
            const icon = sidebarToggle.querySelector('.toggle-icon');
            if (document.body.classList.contains('sidebar-hidden')) {
                icon.innerHTML = '<path d="M3 18H21V16H3V18ZM3 13H21V11H3V13ZM3 6V8H21V6H3Z" fill="currentColor"/>';
            } else {
                icon.innerHTML = '<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z" fill="currentColor"/>';
            }
            
            // 保存状态到本地存储
            localStorage.setItem('sidebarHidden', document.body.classList.contains('sidebar-hidden'));
        }
        
        // 从本地存储恢复侧边栏状态
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
            if (sidebarHidden) {
                document.body.classList.add('sidebar-hidden');
                const icon = sidebarToggle.querySelector('.toggle-icon');
                icon.innerHTML = '<path d="M3 18H21V16H3V18ZM3 13H21V11H3V13ZM3 6V8H21V6H3Z" fill="currentColor"/>';
            }
        });
        
        // 确保添加系统提示词头部点击事件
        systemPromptHeader.addEventListener('click', toggleSystemPromptEditor);
        
        // 从localStorage加载提示词
        function loadPrompts() {
            const savedData = localStorage.getItem('aiChatPrompts');
            let prompts = [];
            
            if (savedData) {
                try {
                    prompts = JSON.parse(savedData);
                } catch (e) {
                    console.error('Error loading saved prompts:', e);
                }
            }
            
            // 确保至少有一个默认提示词
            if (prompts.length === 0) {
                prompts = [
                {
                    id: generateId(),
                    name: '步骤解题助手',
                    text: '你是一位擅长一步一步解决问题的助手。请按照以下方式解答问题：\n1. 首先，理解并分析问题的关键点\n2. 提供清晰的解题思路\n3. 将解题过程分解为小步骤，每个步骤都要详细解释\n4. 在每一步中，说明使用的公式或原理\n5. 如果有多种解法，请依次展示不同方法\n6. 总结解题过程中的关键点和学习要点\n\n对于数学问题，请使用LaTeX格式表示公式。使用清晰的语言，确保解释对初学者也容易理解。'
                },
                {
                    id: generateId(),
                    name: '玖数数学助手',
                    text: '你是玖数人工智能助手，一个有20年经验的高级学者，精通数学问题。每个题目一定要多种不同的方法来解答，每种方法给出重要的思维模型，并会给出题涉及的相关知识点。以杠精的语气回复，但请确保在提供帮助时保持专业和友好。如果问题与学习数理化学科或编程无关，请以同样风格进行回怼。'
                },

                 ];
                savePromptsToStorage(prompts);
            }
            
            return prompts;
        }
        
        // 保存提示词到localStorage
        function savePromptsToStorage(prompts) {
            localStorage.setItem('aiChatPrompts', JSON.stringify(prompts));
        }
        
        // 生成唯一ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // 初始化提示词选择器
        function initPromptSelector() {
            promptSelect.innerHTML = '';
            
            savedPrompts.forEach(prompt => {
                const option = document.createElement('option');
                option.value = prompt.id;
                option.textContent = prompt.name;
                promptSelect.appendChild(option);
            });
            
            // 设置当前提示词
            if (savedPrompts.length > 0) {
                currentPromptId = savedPrompts[0].id;
                promptSelect.value = currentPromptId;
                systemPromptEditor.value = savedPrompts[0].text;
                
                // 更新系统消息
                messages[0] = {
                    role: "system",
                    content: [{ type: "text", text: savedPrompts[0].text }]
                };
            }
            
            // 添加选择事件
            promptSelect.addEventListener('change', function() {
                currentPromptId = this.value;
                const selectedPrompt = savedPrompts.find(p => p.id === currentPromptId);
                if (selectedPrompt) {
                    systemPromptEditor.value = selectedPrompt.text;
                    
                    // 更新系统消息
                    messages[0] = {
                        role: "system",
                        content: [{ type: "text", text: selectedPrompt.text }]
                    };
                }
            });
        }
        
        // 事件监听器
        addPromptBtn.addEventListener('click', createNewPrompt);
        deletePromptBtn.addEventListener('click', deleteCurrentPrompt);
        saveSystemPrompt.addEventListener('click', saveCurrentPrompt);
        
        // 创建新提示词
        function createNewPrompt() {
            promptNameInput.value = "新提示词";
            systemPromptEditor.value = "You are a helpful assistant.";
            currentPromptId = null; // 表示这是一个新提示词
        }
        
        // 删除当前提示词
        function deleteCurrentPrompt() {
            if (!currentPromptId || savedPrompts.length <= 1) {
                alert("至少需要保留一个提示词！");
                return;
            }
            
            if (confirm("确定要删除这个提示词吗？")) {
                savedPrompts = savedPrompts.filter(p => p.id !== currentPromptId);
                savePromptsToStorage(savedPrompts);
                
                // 重新初始化选择器
                initPromptSelector();
            }
        }
        
        // 保存当前提示词
        function saveCurrentPrompt() {
            const promptText = systemPromptEditor.value.trim();
            const promptName = promptNameInput.value.trim() || "未命名提示词";
            
            if (!promptText) {
                alert("提示词内容不能为空！");
                return;
            }
            
            if (currentPromptId) {
                // 更新现有提示词
                const promptIndex = savedPrompts.findIndex(p => p.id === currentPromptId);
                if (promptIndex !== -1) {
                    savedPrompts[promptIndex].text = promptText;
                    savedPrompts[promptIndex].name = promptName;
                }
            } else {
                // 创建新提示词
                const newPrompt = {
                    id: generateId(),
                    name: promptName,
                    text: promptText
                };
                savedPrompts.push(newPrompt);
                currentPromptId = newPrompt.id;
            }
            
            // 保存到localStorage
            savePromptsToStorage(savedPrompts);
            
            // 更新系统消息
            messages[0] = {
                role: "system",
                content: [{ type: "text", text: promptText }]
            };
            
            // 重新初始化选择器
            initPromptSelector();
            
            alert("提示词已保存！");
            toggleSystemPromptEditor(); // 关闭编辑器
        }
        
        // 切换系统提示词编辑器显示状态
        function toggleSystemPromptEditor() {
            const isVisible = systemPromptEditor.style.display === 'block';
            systemPromptEditor.style.display = isVisible ? 'none' : 'block';
            promptControls.style.display = isVisible ? 'none' : 'flex';
            saveButtons.style.display = isVisible ? 'none' : 'flex';
            togglePrompt.textContent = isVisible ? '▼' : '▲';
            
            if (!isVisible) {
                // 当打开编辑器时，设置当前提示词名称
                const selectedPrompt = savedPrompts.find(p => p.id === currentPromptId);
                if (selectedPrompt) {
                    promptNameInput.value = selectedPrompt.name;
                }
            }
            
            // 打印调试信息
            console.log('Toggle prompt editor:', isVisible ? 'hiding' : 'showing');
        }
        
        // 事件监听
        imageBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', handleImageInput);
        sendBtn.addEventListener('click', sendMessage);
        
        // 添加粘贴事件监听
        userInput.addEventListener('paste', handlePaste);
        
        // 添加键盘事件监听
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // 处理粘贴事件
        function handlePaste(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            
            for (const item of items) {
                if (item.type.indexOf('image') === 0) {
                    const blob = item.getAsFile();
                    currentMediaType = "image";
                    currentMediaFiles.push(blob);
                    displayImagePreviews(currentMediaFiles);
                    break;
                }
            }
        }
        
        // 处理图片输入
        function handleImageInput(event) {
            currentMediaType = "image";
            imageBtn.classList.add('active');
            
            const files = event.target.files;
            if (files.length > 0) {
                currentMediaFiles = [...currentMediaFiles, ...Array.from(files)];
                displayImagePreviews(currentMediaFiles);
            }
        }
        
        // 重置媒体选择
        function resetMediaSelection() {
            currentMediaFiles = [];
            imageBtn.classList.remove('active');
            previewContainer.innerHTML = '';
        }
        
        // 显示图片预览
        function displayImagePreviews(files) {
            previewContainer.innerHTML = '';
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '100px';
                    img.style.maxHeight = '100px';
                    
                    const removeBtn = document.createElement('div');
                    removeBtn.className = 'remove-btn';
                    removeBtn.textContent = 'x';
                    removeBtn.onclick = () => removeFile(index);
                    
                    previewItem.appendChild(img);
                    previewItem.appendChild(removeBtn);
                    previewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });
        }
        
        // 移除文件
        function removeFile(index) {
            currentMediaFiles.splice(index, 1);
            if (currentMediaFiles.length === 0) {
                resetMediaSelection();
            } else {
                displayImagePreviews(currentMediaFiles);
            }
        }
        
        // 发送消息
        async function sendMessage() {
            const text = userInput.value.trim();
            if ((!text && !currentMediaFiles.length) || loading.style.display === 'block') return;
            
            // 检查文件大小
            const MAX_FILE_SIZE = 8 * 1024 * 1024; // 8MB limit (produces ~10-11MB base64)
            for (const file of currentMediaFiles) {
                if (file.size > MAX_FILE_SIZE) {
                    alert(`文件 "${file.name || '粘贴的图片'}" 太大，请上传小于8MB的文件。`);
                    return;
                }
            }
            
            // 创建用户消息内容
            const userContent = [];
            
            // 添加媒体内容
            if (currentMediaFiles.length > 0) {
                for (const file of currentMediaFiles) {
                    const base64Data = await fileToBase64(file);
                    userContent.push({
                        type: "image_url",
                        image_url: { url: base64Data }
                    });
                }
            }
            
            // 添加文本内容
            if (text) {
                userContent.push({ type: "text", text: text });
            }
            
            // 添加用户消息到历史
            const userMessage = {
                role: "user",
                content: userContent,
                timestamp: new Date().toISOString() // 保存时间戳
            };
            
            messages.push(userMessage);
            
            // 显示用户消息
            addMessageToChat('user', userContent);
            
            // 清空输入
            userInput.value = '';
            resetMediaSelection();
            
            // 发送请求
            loading.style.display = 'block';
            try {
                const response = await sendRequest(messages);
                
                // 只添加助手消息到历史，不再添加到聊天界面（已经由流式响应处理）
                messages.push({
                    role: "assistant",
                    content: [{ type: "text", text: response }],
                    timestamp: new Date().toISOString() // 保存时间戳
                });
                
                // 保存当前会话
                saveCurrentSession();
            } catch (error) {
                console.error("API 请求错误:", error);
                addMessageToChat('assistant', [{ type: "text", text: "抱歉，发生了错误: " + error.message }]);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // 将文件转换为 Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // LaTeX 渲染相关变量
        let renderLatex = true;
        const latexToggle = document.getElementById('latexToggle');
        
        // 添加 LaTeX 开关事件监听
        latexToggle.addEventListener('change', function() {
            renderLatex = this.checked;
            refreshChatHistory();
        });
        
        // 刷新聊天历史以应用 LaTeX 渲染设置
        function refreshChatHistory() {
            // 保存当前滚动位置
            const scrollPosition = chatHistory.scrollTop;
            
            // 清空聊天历史
            chatHistory.innerHTML = '';
            
            // 重新添加消息
            for (let i = 1; i < messages.length; i++) {
                const message = messages[i];
                addMessageToChat(message.role, message.content, false);
            }
            
            // 恢复滚动位置
            chatHistory.scrollTop = scrollPosition;
        }
        
        // 向 API 发送请求
        async function sendRequest(messages) {
            const url = `${BASE_URL}/chat/completions`;
            
            const requestBody = {
                model: MODEL,
                messages: messages,
                stream: true,
                modalities: ["text"],
                max_tokens: 1000 // 限制响应长度
            };
            
            let fullResponse = '';
            
            return new Promise((resolve, reject) => {
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            throw new Error(err.error?.message || '请求失败');
                        });
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let firstChunk = true;
                    
                    function read() {
                        return reader.read().then(({ done, value }) => {
                            if (done) {
                                return resolve(fullResponse);
                            }
                            
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n');
                            
                            for (const line of lines) {
                                if (line.startsWith('data:') && line !== 'data: [DONE]') {
                                    try {
                                        const jsonStr = line.substring(5).trim();
                                        const data = JSON.parse(jsonStr);
                                        
                                        if (data.choices && data.choices[0]?.delta?.content) {
                                            const content = data.choices[0].delta.content;
                                            
                                            // 对第一个数据块特殊处理，添加前缀
                                            if (firstChunk) {
                                                fullResponse = '玖数：' + content;
                                                firstChunk = false;
                                            } else {
                                                fullResponse += content;
                                            }
                                            
                                            // 实时更新聊天界面
                                            const lastMessage = chatHistory.lastElementChild;
                                            if (lastMessage && lastMessage.classList.contains('assistant-message')) {
                                                const textDiv = lastMessage.firstElementChild || lastMessage;
                                                
                                                if (renderLatex) {
                                                    // 处理 LaTeX 渲染
                                                    let processedText = fullResponse
                                                        .replace(/\$\$([\s\S]*?)\$\$/g, function(match, p1) {
                                                            return '\\[' + p1 + '\\]';
                                                        })
                                                        .replace(/\$((?!\$)[\s\S]*?)\$/g, function(match, p1) {
                                                            return '\\(' + p1 + '\\)';
                                                        });
                                                    
                                                    textDiv.innerHTML = processedText;
                                                    
                                                    // 尝试渲染 LaTeX
                                                    if (window.MathJax) {
                                                        MathJax.typesetPromise([textDiv]).catch(err => {});
                                                    }
                                                } else {
                                                    // 显示原始文本
                                                    let processedText = fullResponse
                                                        .replace(/\$\$([\s\S]*?)\$\$/g, function(match, p1) {
                                                            return '<span class="latex-raw">$$' + p1 + '$$</span>';
                                                        })
                                                        .replace(/\$((?!\$)[\s\S]*?)\$/g, function(match, p1) {
                                                            return '<span class="latex-raw">$' + p1 + '$</span>';
                                                        });
                                                    
                                                    textDiv.innerHTML = processedText;
                                                }
                                            } else {
                                                // 创建新的消息元素
                                                const messageDiv = document.createElement('div');
                                                messageDiv.className = 'message assistant-message';
                                                
                                                const textDiv = document.createElement('div');
                                                messageDiv.appendChild(textDiv);
                                                
                                                if (renderLatex) {
                                                    let processedText = fullResponse
                                                        .replace(/\$\$([\s\S]*?)\$\$/g, function(match, p1) {
                                                            return '\\[' + p1 + '\\]';
                                                        })
                                                        .replace(/\$((?!\$)[\s\S]*?)\$/g, function(match, p1) {
                                                            return '\\(' + p1 + '\\)';
                                                        });
                                                    
                                                    textDiv.innerHTML = processedText;
                                                } else {
                                                    let processedText = fullResponse
                                                        .replace(/\$\$([\s\S]*?)\$\$/g, function(match, p1) {
                                                            return '<span class="latex-raw">$$' + p1 + '$$</span>';
                                                        })
                                                        .replace(/\$((?!\$)[\s\S]*?)\$/g, function(match, p1) {
                                                            return '<span class="latex-raw">$' + p1 + '$</span>';
                                                        });
                                                    
                                                    textDiv.innerHTML = processedText;
                                                }
                                                
                                                // 添加时间戳
                                                const timestamp = document.createElement('div');
                                                timestamp.className = 'message-timestamp';
                                                timestamp.textContent = new Date().toLocaleTimeString('zh-CN');
                                                messageDiv.appendChild(timestamp);
                                                
                                                chatHistory.appendChild(messageDiv);
                                            }
                                            
                                            // 滚动到底部
                                            chatHistory.scrollTop = chatHistory.scrollHeight;
                                        }
                                    } catch (error) {
                                        console.error("Parse error:", error);
                                    }
                                }
                            }
                            
                            return read();
                        });
                    }
                    
                    return read();
                })
                .catch(error => {
                    reject(error);
                });
            });
        }
        
        // 将消息添加到聊天界面
        function addMessageToChat(role, content, scroll = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            
            for (const item of content) {
                if (item.type === "text") {
                    const textDiv = document.createElement('div');
                    
                    // 处理文本中的 LaTeX
                    if (renderLatex) {
                        // 将文本中的 LaTeX 代码包装在 MathJax 标记中
                        // 行内公式：$...$
                        // 块级公式：$$...$$
                        let processedText = item.text;
                        
                        // 如果是助手消息，在开头添加"玖数："前缀
                        if (role === 'assistant' && !processedText.startsWith('玖数：')) {
                            processedText = '玖数：' + processedText;
                        }
                        
                        processedText = processedText
                            .replace(/\$\$([\s\S]*?)\$\$/g, function(match, p1) {
                                return '\\[' + p1 + '\\]';
                            })
                            .replace(/\$((?!\$)[\s\S]*?)\$/g, function(match, p1) {
                                return '\\(' + p1 + '\\)';
                            });
                        
                        textDiv.innerHTML = processedText;
                        
                        // 在下一个事件循环中触发 MathJax 渲染
                        setTimeout(() => {
                            if (window.MathJax) {
                                MathJax.typesetPromise([textDiv]).catch(err => console.error('MathJax error:', err));
                            }
                        }, 0);
                    } else {
                        // 显示原始文本，不渲染 LaTeX
                        let processedText = item.text;
                        
                        // 如果是助手消息，在开头添加"玖数："前缀
                        if (role === 'assistant' && !processedText.startsWith('玖数：')) {
                            processedText = '玖数：' + processedText;
                        }
                        
                        processedText = processedText
                            .replace(/\$\$([\s\S]*?)\$\$/g, function(match, p1) {
                                return '<span class="latex-raw">$$' + p1 + '$$</span>';
                            })
                            .replace(/\$((?!\$)[\s\S]*?)\$/g, function(match, p1) {
                                return '<span class="latex-raw">$' + p1 + '$</span>';
                            });
                        
                        textDiv.innerHTML = processedText;
                    }
                    
                    messageDiv.appendChild(textDiv);
                } else if (item.type === "image_url") {
                    const img = document.createElement('img');
                    img.src = item.image_url.url;
                    img.style.maxWidth = '200px';
                    img.style.maxHeight = '200px';
                    img.style.marginTop = '10px';
                    messageDiv.appendChild(img);
                }
            }
            
            // 添加时间戳
            const timestamp = document.createElement('div');
            timestamp.className = 'message-timestamp';
            timestamp.textContent = new Date().toLocaleTimeString('zh-CN');
            messageDiv.appendChild(timestamp);
            
            chatHistory.appendChild(messageDiv);
            if (scroll) {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }
        
        // 初始提示
        addMessageToChat('assistant', [{ type: "text", text: "" }]);
        
        // 加载对话历史记录
        function loadChatSessions() {
            const savedData = localStorage.getItem('aiChatSessions');
            let sessions = [];
            
            if (savedData) {
                try {
                    sessions = JSON.parse(savedData);
                } catch (e) {
                    console.error('Error loading saved chat sessions:', e);
                }
            }
            
            return sessions;
        }
        
        // 保存对话历史记录
        function saveChatSessions(sessions) {
            localStorage.setItem('aiChatSessions', JSON.stringify(sessions));
        }
        
        // 获取或创建当前会话ID
        function getCurrentSessionId() {
            let id = localStorage.getItem('aiCurrentSessionId');
            
            if (!id) {
                id = createNewSession();
                localStorage.setItem('aiCurrentSessionId', id);
            }
            
            return id;
        }
        
        // 创建新的会话
        function createNewSession() {
            const timestamp = new Date().toLocaleString('zh-CN');
            const id = generateId();
            
            chatSessions.unshift({
                id: id,
                name: `对话 ${timestamp}`,
                messages: [messages[0]], // 只保留系统消息
                created: Date.now()
            });
            
            saveChatSessions(chatSessions);
            return id;
        }
        
        // 初始化聊天历史列表
        function initChatHistory() {
            // 加载当前会话消息
            loadCurrentSession();
            
            // 渲染历史列表
            renderHistoryList();
        }
        
        // 切换历史记录面板
        function toggleHistoryControls() {
            const isVisible = historyControls.style.display === 'flex';
            historyControls.style.display = isVisible ? 'none' : 'flex';
            toggleHistory.textContent = isVisible ? '▼' : '▲';
            
            // 添加调试信息
            console.log('Toggle history controls:', isVisible ? 'hiding' : 'showing');
        }
        
        // 添加直接点击切换按钮的事件
        toggleHistory.addEventListener('click', function(e) {
            e.stopPropagation(); // 防止事件冒泡
            toggleHistoryControls();
        });
        
        // 渲染历史记录列表
        function renderHistoryList() {
            historyList.innerHTML = '';
            
            // 调试当前历史记录状态
            console.log('Current sessions:', chatSessions);
            console.log('Current session ID:', currentSessionId);
            
            chatSessions.forEach(session => {
                const item = document.createElement('div');
                item.className = `history-item ${session.id === currentSessionId ? 'active' : ''}`;
                item.dataset.id = session.id;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'history-name';
                nameSpan.textContent = session.name;
                
                const actions = document.createElement('div');
                actions.className = 'history-actions';
                
                const renameBtn = document.createElement('span');
                renameBtn.className = 'history-action';
                renameBtn.textContent = '重命名';
                renameBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    renameSession(session.id);
                });
                
                actions.appendChild(renameBtn);
                
                item.appendChild(nameSpan);
                item.appendChild(actions);
                
                // 点击加载会话
                item.addEventListener('click', () => loadSession(session.id));
                
                historyList.appendChild(item);
            });
        }
        
        // 重命名会话
        function renameSession(sessionId) {
            const session = chatSessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const item = document.querySelector(`.history-item[data-id="${sessionId}"]`);
            if (!item) return;
            
            const nameSpan = item.querySelector('.history-name');
            const currentName = session.name;
            
            // 创建重命名输入框
            const input = document.createElement('input');
            input.className = 'rename-input';
            input.value = currentName;
            input.addEventListener('click', e => e.stopPropagation());
            input.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                    submitRename(sessionId, input.value);
                } else if (e.key === 'Escape') {
                    cancelRename(nameSpan, currentName);
                }
            });
            
            // 保存旧内容并替换
            nameSpan.innerHTML = '';
            nameSpan.appendChild(input);
            input.focus();
            input.select();
            
            // 点击其他地方时保存
            function handleClickOutside(e) {
                if (!input.contains(e.target)) {
                    submitRename(sessionId, input.value);
                    document.removeEventListener('click', handleClickOutside);
                }
            }
            
            // 延迟添加事件监听器，避免立即触发
            setTimeout(() => {
                document.addEventListener('click', handleClickOutside);
            }, 0);
        }
        
        // 提交重命名
        function submitRename(sessionId, newName) {
            newName = newName.trim();
            if (!newName) return;
            
            // 更新会话名称
            const sessionIndex = chatSessions.findIndex(s => s.id === sessionId);
            if (sessionIndex !== -1) {
                chatSessions[sessionIndex].name = newName;
                saveChatSessions(chatSessions);
                renderHistoryList();
            }
        }
        
        // 取消重命名
        function cancelRename(nameSpan, originalName) {
            nameSpan.textContent = originalName;
        }
        
        // 加载当前会话
        function loadCurrentSession() {
            const session = chatSessions.find(s => s.id === currentSessionId);
            
            if (session && session.messages && session.messages.length > 0) {
                // 加载消息
                messages = [...session.messages];
                
                // 刷新聊天界面
                refreshChatHistory();
            } else {
                // 如果找不到会话或消息为空，则创建新会话
                currentSessionId = createNewSession();
                localStorage.setItem('aiCurrentSessionId', currentSessionId);
                messages = [messages[0]]; // 只保留系统消息
                chatHistory.innerHTML = '';
                addMessageToChat('assistant', [{ type: "text", text: "" }]);
            }
        }
        
        // 加载指定会话
        function loadSession(sessionId) {
            // 保存当前会话
            saveCurrentSession();
            
            // 更新当前会话ID
            currentSessionId = sessionId;
            localStorage.setItem('aiCurrentSessionId', sessionId);
            
            // 加载选中的会话
            loadCurrentSession();
            
            // 更新UI
            renderHistoryList();
        }
        
        // 保存当前会话
        function saveCurrentSession() {
            const sessionIndex = chatSessions.findIndex(s => s.id === currentSessionId);
            
            if (sessionIndex !== -1) {
                chatSessions[sessionIndex].messages = [...messages];
                saveChatSessions(chatSessions);
            } else {
                // 如果会话不存在，创建新会话
                chatSessions.unshift({
                    id: currentSessionId,
                    name: `对话 ${new Date().toLocaleString('zh-CN')}`,
                    messages: [...messages],
                    created: Date.now()
                });
                saveChatSessions(chatSessions);
            }
        }
        
        // 开始新对话
        function startNewChat() {
            // 保存当前会话
            saveCurrentSession();
            
            // 创建新会话
            currentSessionId = createNewSession();
            localStorage.setItem('aiCurrentSessionId', currentSessionId);
            
            // 只保留系统消息
            messages = [messages[0]];
            
            // 清空聊天界面并添加欢迎消息
            chatHistory.innerHTML = '';
            addMessageToChat('assistant', [{ type: "text", text: "" }]);
            
            // 更新UI
            renderHistoryList();
        }
        
        // 删除选中的历史
        function deleteSelectedHistory() {
            if (chatSessions.length <= 1) {
                alert("至少需要保留一个对话！");
                return;
            }
            
            if (confirm("确定要删除当前对话吗？")) {
                // 删除当前会话
                chatSessions = chatSessions.filter(s => s.id !== currentSessionId);
                saveChatSessions(chatSessions);
                
                // 切换到第一个会话
                currentSessionId = chatSessions[0].id;
                localStorage.setItem('aiCurrentSessionId', currentSessionId);
                
                // 加载新的当前会话
                loadCurrentSession();
                
                // 更新UI
                renderHistoryList();
            }
        }
        
        // 在页面关闭时保存当前会话
        window.addEventListener('beforeunload', () => {
            saveCurrentSession();
        });
        
        // 等待DOM完全加载后再初始化历史记录控件
        document.addEventListener('DOMContentLoaded', function() {
            // 确保获取所有历史记录相关DOM元素
            const historyHeader = document.getElementById('historyHeader');
            const toggleHistory = document.getElementById('toggleHistory');
            const historyControls = document.getElementById('historyControls');
            const historyList = document.getElementById('historyList');
            const newChatBtn = document.getElementById('newChatBtn');
            const deleteHistoryBtn = document.getElementById('deleteHistoryBtn');
            
            console.log('History DOM elements:', { 
                historyHeader, toggleHistory, historyControls, 
                historyList, newChatBtn, deleteHistoryBtn 
            });
            
            // 确保初始化历史记录面板样式
            historyControls.style.display = 'none';
            
            // 移除旧的事件监听器（如果有）
            historyHeader.removeEventListener('click', toggleHistoryControls);
            toggleHistory.removeEventListener('click', toggleHistoryControls);
            
            // 重新添加事件监听器 - 直接使用内联函数避免引用问题
            historyHeader.addEventListener('click', function() {
                const isVisible = historyControls.style.display === 'flex';
                console.log('History header clicked, current visibility:', isVisible);
                historyControls.style.display = isVisible ? 'none' : 'flex';
                toggleHistory.textContent = isVisible ? '▼' : '▲';
            });
            
            // 为按钮添加事件监听器
            if (newChatBtn) newChatBtn.addEventListener('click', startNewChat);
            if (deleteHistoryBtn) deleteHistoryBtn.addEventListener('click', deleteSelectedHistory);
            
            // 初始化历史记录
            initChatHistory();
        });
        
        // 添加一个全局的直接操作函数用于调试
        window.toggleHistoryPanel = function() {
            const historyControls = document.getElementById('historyControls');
            const toggleHistory = document.getElementById('toggleHistory');
            const isVisible = historyControls.style.display === 'flex';
            
            console.log('Manual toggle, current visibility:', isVisible);
            historyControls.style.display = isVisible ? 'none' : 'flex';
            toggleHistory.textContent = isVisible ? '▼' : '▲';
            return 'History panel is now ' + (isVisible ? 'hidden' : 'visible');
        };

        // 语音识别相关变量和初始化
        let recognition = null;
        const voiceBtn = document.getElementById('voiceBtn');
        let isRecording = false;
        let recordingTimeout = null;
        let accumulatedText = ''; // 用于累积所有识别的文本
        let interimText = ''; // 用于显示实时识别的文本

        // 检查是否在 Electron 环境中
        const isElectron = window.navigator.userAgent.toLowerCase().includes('electron');

        // 初始化语音识别
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                voiceBtn.style.display = 'none';
                console.warn('Browser does not support speech recognition');
                return;
            }

            try {
                recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'zh-CN';

                // 语音识别结果处理
                recognition.onresult = function(event) {
                    const results = event.results;
                    const lastResult = results[results.length - 1];
                    const currentText = lastResult[0].transcript;
                    
                    if (lastResult.isFinal) {
                        accumulatedText += currentText + ' ';
                        interimText = '';
                    } else {
                        interimText = currentText;
                    }
                    
                    userInput.value = (accumulatedText + interimText).trim();
                };

                recognition.onend = function() {
                    if (isRecording) {
                        // 如果还在录音状态，重新开始录音
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error('Failed to restart recognition:', e);
                            stopRecording();
                        }
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopRecording();
                    
                    // 针对 Electron 环境的错误处理
                    if (isElectron && event.error === 'not-allowed') {
                        alert('请确保已授予麦克风访问权限。您可以在系统设置中修改权限设置。');
                    } else {
                        alert('语音识别出错: ' + event.error);
                    }
                };

                // 在 Electron 环境中请求麦克风权限
                if (isElectron) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            stream.getTracks().forEach(track => track.stop());
                            console.log('Microphone permission granted');
                        })
                        .catch(err => {
                            console.error('Microphone permission denied:', err);
                            alert('请允许访问麦克风以使用语音功能');
                        });
                }
            } catch (e) {
                console.error('Failed to initialize speech recognition:', e);
                voiceBtn.style.display = 'none';
            }
        }

        // 开始录音
        function startRecording() {
            if (!recognition) {
                initSpeechRecognition();
                if (!recognition) return;
            }
            
            try {
                isRecording = true;
                accumulatedText = '';
                interimText = '';
                userInput.value = '';
                voiceBtn.classList.add('recording');
                voiceStatus.style.display = 'block';
                recognition.start();
            } catch (e) {
                console.error('Failed to start recording:', e);
                stopRecording();
                alert('启动语音识别失败，请刷新页面重试');
            }
        }

        // 停止录音
        function stopRecording() {
            if (!recognition) return;
            
            try {
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceStatus.style.display = 'none';
                recognition.stop();
                
                if (accumulatedText.trim()) {
                    sendMessage();
                }
            } catch (e) {
                console.error('Failed to stop recording:', e);
            }
        }

        // 初始化语音识别
        initSpeechRecognition();

        // 语音按钮事件处理
        voiceBtn.addEventListener('mousedown', function(e) {
            e.preventDefault();
            startRecording();
        });

        voiceBtn.addEventListener('mouseup', function(e) {
            e.preventDefault();
            stopRecording();
        });

        voiceBtn.addEventListener('mouseleave', function(e) {
            if (isRecording) {
                stopRecording();
            }
        });

        // 触摸设备支持
        voiceBtn.addEventListener('touchstart', function(e) {
            e.preventDefault();
            startRecording();
        });

        voiceBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            stopRecording();
        });
    </script>
</body>
</html>
