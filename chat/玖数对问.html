<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>玖数对问</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        button {
            font-size: 20px;
            margin: 20px;
            padding: 10px 20px;
            cursor: pointer;
        }

        #status {
            font-size: 18px;
            color: green;
        }

#messages {
    margin-top: 20px;
    text-align: center;
    margin: 20px auto; /* 上下20px，左右自动居中 */
    width: 80%; /* 可以根据需要调整宽度 */
}

        #controls {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h1>玖数对问</h1>

<button id="startButton">按住录音</button>

<div id="controls">
    <button id="stopPlaybackButton" style="display: none;">停止回复</button>
</div>
<p id="status">状态：等待录音...</p>
<div id="messages"></div>


<script>
    const apiKey = "046acb99c5a6dd6680049c766c8b454b.Jc1U4euX045uExXU";  // 替换为你的 API 密钥
    let audioRecorder;
    let audioChunks = [];
    let isRecording = false;
    let isReplying = false;
    let conversationHistory = [];
    let audioStream;
    let audioElement;

    const startButton = document.getElementById('startButton');
    const statusElement = document.getElementById('status');
    const messagesElement = document.getElementById('messages');
    const stopPlaybackButton = document.getElementById('stopPlaybackButton');

    startButton.onmousedown = () => {
        if (!isRecording && !isReplying) {
            startRecording();
        } else if (isReplying) {
            stopAudioPlayback();
            startRecording();
        }
    };

    startButton.onmouseup = () => {
        if (isRecording) {
            stopRecording();
        }
    };

    stopPlaybackButton.onclick = () => {
        stopAudioPlayback();
    };

    async function startRecording() {
        audioChunks = [];
        isRecording = true;
        statusElement.innerText = '状态：正在录音...';
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioStream = stream;
            audioRecorder = new MediaRecorder(stream);
            audioRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            audioRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                sendAudioToServer(audioBlob);
            };
            audioRecorder.start();
        } catch (error) {
            console.error('录音失败', error);
            statusElement.innerText = '状态：录音失败，请检查麦克风权限';
        }
    }

    function stopRecording() {
        if (audioRecorder) {
            audioRecorder.stop();
            audioStream.getTracks().forEach(track => track.stop());
            isRecording = false;
            statusElement.innerText = '状态：录音已停止';
        }
    }

    async function sendAudioToServer(audioBlob) {
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64Audio = reader.result.split(',')[1];
            const requestPayload = {
                model: "glm-4-voice",
                messages: buildMessages(base64Audio),
                max_tokens: 1024,
                stream: false
            };
            try {
                const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestPayload)
                });
                const data = await response.json();
                handleResponse(data);
            } catch (error) {
                console.error('API 请求失败', error);
                statusElement.innerText = '状态：与服务器通信失败';
            }
        };
        reader.readAsDataURL(audioBlob);
    }

    function buildMessages(base64Audio) {
        let messages = [{
            role: "user",
            content: [{
                type: "input_audio",
                input_audio: { data: base64Audio, format: "wav" }
            }]
        }];

        conversationHistory.forEach(item => {
            messages.push(item.audio ? { role: item.role, audio: { id: item.audio.id } } : { role: item.role, content: item.content });
        });

        return messages.reverse();
    }

    function base64ToBlob(base64) {
        const binaryString = atob(base64);
        const arrayBuffer = new ArrayBuffer(binaryString.length);
        const uint8Array = new Uint8Array(arrayBuffer);
        for (let i = 0; i < binaryString.length; i++) {
            uint8Array[i] = binaryString.charCodeAt(i);
        }
        return new Blob([uint8Array], { type: 'audio/wav' });
    }

    function playAudio(blob) {
        stopAudioPlayback();

        const audioUrl = URL.createObjectURL(blob);
        audioElement = document.createElement('audio');
        audioElement.src = audioUrl;
        audioElement.play().catch(error => {
            console.error("音频播放失败：", error);
        });
        messagesElement.innerHTML += `<p>玖数正在回复...</p>`;
        stopPlaybackButton.style.display = 'inline-block';
        isReplying = true;

        audioElement.onended = () => {
            isReplying = false;
            statusElement.innerText = '状态：等待录音...';
            stopPlaybackButton.style.display = 'none';
        };
    }

    function stopAudioPlayback() {
        if (audioElement) {
            audioElement.pause();
            audioElement.currentTime = 0;
            isReplying = false;
            statusElement.innerText = '状态：等待录音...';
            stopPlaybackButton.style.display = 'none';
        }
    }

    function handleResponse(data) {
        console.log('API 响应：', data);
        if (data.choices && data.choices[0].message) {
            const message = data.choices[0].message;
            if (message.audio) {
                const audioData = message.audio.data;
                const audioBlob = base64ToBlob(audioData);
                playAudio(audioBlob);
            } else {
                messagesElement.innerHTML += `<p>AI: ${message.content}</p>`;
            }

            if (message.audio && message.audio.id) {
                conversationHistory.push({ role: "assistant", audio: { id: message.audio.id } });
            } else {
                conversationHistory.push({ role: "assistant", content: message.content });
            }
        }
    }
</script>

</body>
</html>
